{% extends 'base.html' %}

{% block title %}Activity Logs{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="mb-0">Activity Logs</h2>
        <div>
            <button id="refresh-logs" class="btn btn-outline-primary btn-sm">Refresh</button>
            <a href="{{ url_for('auth.manage_users') }}" class="btn btn-outline-secondary btn-sm ms-2">User Management</a>
        </div>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="search-logs" class="form-control" placeholder="Search logs...">
            </div>
            <div class="col-md-3">
                <select id="filter-action" class="form-select">
                    <option value="">All Actions</option>
                    <option value="LOGIN">Login</option>
                    <option value="LOGOUT">Logout</option>
                    <option value="ADD_ROW">Add Row</option>
                    <option value="EDIT_ROW">Edit Row</option>
                    <option value="DELETE_ROW">Delete Row</option>
                    <option value="VIEW_TABLE">View Table</option>
                    <option value="API_ACCESS">API Access</option>
                    <option value="USER_CREATED">User Created</option>
                    <option value="DELETE_USER">User Deleted</option>
                    <option value="VIEW_USERS">View Users</option>
                    <option value="VIEW_LOGS">View Logs</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="filter-user" class="form-select">
                    <option value="">All Users</option>
                    {% set users = [] %}
                    {% for log in logs %}
                        {% if 'USER:' in log %}
                            {% set user = log.split('USER:')[1].split('(')[0].strip() %}
                            {% if user not in users %}
                                {% set _ = users.append(user) %}
                                <option value="{{ user }}">{{ user }}</option>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button id="clear-filters" class="btn btn-outline-secondary btn-sm w-100">Clear Filters</button>
            </div>
        </div>
        
        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-sm table-striped">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>Timestamp</th>
                        <th>Action</th>
                        <th>User</th>
                        <th>Table</th>
                        <th>Row ID</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="logs-tbody">
                    {% for log in logs %}
                        {% set parts = log.split(' - ') %}
                        {% set timestamp = parts[0] if parts else '' %}
                        {% set action = parts[1].replace('ACTION: ', '') if parts|length > 1 else '' %}
                        {% set user_part = parts[2] if parts|length > 2 else '' %}
                        {% set user = user_part.split(' (')[0].replace('USER: ', '') if 'USER:' in user_part else '' %}
                        {% set table = parts[3].replace('TABLE: ', '') if parts|length > 3 and 'TABLE:' in parts[3] else '' %}
                        {% set row_id = parts[4].replace('ROW_ID: ', '') if parts|length > 4 and 'ROW_ID:' in parts[4] else '' %}
                        {% set details = ' - '.join(parts[5:]).replace('DETAILS: ', '') if parts|length > 5 else '' %}
                        
                        <tr class="log-row" 
                            data-action="{{ action }}" 
                            data-user="{{ user }}" 
                            data-table="{{ table }}" 
                            data-row-id="{{ row_id }}" 
                            data-details="{{ details }}">
                            <td class="text-muted" style="font-size: 0.9em;">{{ timestamp }}</td>
                            <td><span class="badge bg-primary">{{ action }}</span></td>
                            <td><strong>{{ user }}</strong></td>
                            <td>{{ table if table else '-' }}</td>
                            <td>{{ row_id if row_id else '-' }}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ details }}">
                                {{ details if details else '-' }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <small class="text-muted">
                Showing last 1000 log entries. Log file: activity.log
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-logs');
    const actionFilter = document.getElementById('filter-action');
    const userFilter = document.getElementById('filter-user');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const refreshBtn = document.getElementById('refresh-logs');
    const logsTbody = document.getElementById('logs-tbody');
    const logRows = document.querySelectorAll('.log-row');

    function filterLogs() {
        const searchTerm = searchInput.value.toLowerCase();
        const actionTerm = actionFilter.value;
        const userTerm = userFilter.value;

        logRows.forEach(row => {
            const action = row.getAttribute('data-action');
            const user = row.getAttribute('data-user');
            const table = row.getAttribute('data-table');
            const rowId = row.getAttribute('data-row-id');
            const details = row.getAttribute('data-details');
            
            const matchesSearch = !searchTerm || 
                action.toLowerCase().includes(searchTerm) ||
                user.toLowerCase().includes(searchTerm) ||
                table.toLowerCase().includes(searchTerm) ||
                rowId.toLowerCase().includes(searchTerm) ||
                details.toLowerCase().includes(searchTerm);
            
            const matchesAction = !actionTerm || action === actionTerm;
            const matchesUser = !userTerm || user === userTerm;
            
            if (matchesSearch && matchesAction && matchesUser) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', filterLogs);
    actionFilter.addEventListener('change', filterLogs);
    userFilter.addEventListener('change', filterLogs);

    clearFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        actionFilter.value = '';
        userFilter.value = '';
        filterLogs();
    });

    refreshBtn.addEventListener('click', function() {
        location.reload();
    });
});
</script>
{% endblock %} 