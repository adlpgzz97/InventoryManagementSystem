{% extends 'base.html' %}
{% import 'form_macros.html' as forms %}

{% block title %}Add Row to {{ table_name|capitalize }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <h2 class="card-title mb-4">Add Row to {{ table_name|capitalize }}</h2>
        <form method="post">
            {% set id_col = form_columns[0][0] if form_columns and form_columns[0][0].endswith('_id') else None %}
            {% for col, dtype, is_nullable in form_columns %}
                {% if col != id_col and 'uuid' not in col|lower %}
                    <div class="mb-3">
                        <label for="{{ col }}" class="form-label">
                            {{ prettify_column_name(col) }} ({{ dtype }})
                            {% if is_nullable == 'NO' %}<span style="color:red">*</span>{% endif %}
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="{{ col }}" name="{{ col }}" {% if is_nullable == 'NO' %}required{% endif %}>
                            {% if 'date' in col|lower %}
                                <button type="button" class="btn btn-outline-secondary today-btn" data-target="{{ col }}">Today</button>
                            {% endif %}
                            {% if table_name == 'experiments' and col == 'sample_id' %}
                                <button type="button" class="btn btn-outline-info auto-fill-btn" data-target="batch_id" data-source="sample_id">Auto Fill Batch</button>
                            {% endif %}
                            {% if col == 'file_location' %}
                                <button type="button" class="btn btn-outline-primary browse-btn" data-target="{{ col }}">Browse</button>
                                <input type="file" id="file-input-{{ col }}" style="display: none;" accept=".doc,.docx,.xls,.xlsx,.pdf,.txt">
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            <button type="submit" class="btn btn-success">Add Row</button>
            <a href="/table/{{ table_name }}" class="btn btn-secondary ms-2">Back to {{ table_name|capitalize }}</a>
        </form>
        <p class="mt-2"><span style="color:red">*</span> Required field</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Today button functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('today-btn')) {
            const targetId = e.target.getAttribute('data-target');
            const targetInput = document.getElementById(targetId);
            if (targetInput) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;
                targetInput.value = todayString;
            }
        }
    });
    
    // Auto-fill button functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('auto-fill-btn')) {
            const targetId = e.target.getAttribute('data-target');
            const sourceId = e.target.getAttribute('data-source');
            const targetInput = document.getElementById(targetId);
            const sourceInput = document.getElementById(sourceId);
            
            if (targetInput && sourceInput && sourceInput.value.trim()) {
                const sampleId = sourceInput.value.trim();
                
                // Show loading state
                e.target.textContent = 'Loading...';
                e.target.disabled = true;
                
                fetch(`/api/sample/${sampleId}/batch`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            targetInput.value = data.batch_id;
                            e.target.textContent = '✓ Filled';
                            e.target.classList.remove('btn-outline-info');
                            e.target.classList.add('btn-success');
                            setTimeout(() => {
                                e.target.textContent = 'Auto Fill Batch';
                                e.target.classList.remove('btn-success');
                                e.target.classList.add('btn-outline-info');
                                e.target.disabled = false;
                            }, 2000);
                        } else {
                            e.target.textContent = 'Not Found';
                            e.target.classList.remove('btn-outline-info');
                            e.target.classList.add('btn-danger');
                            setTimeout(() => {
                                e.target.textContent = 'Auto Fill Batch';
                                e.target.classList.remove('btn-danger');
                                e.target.classList.add('btn-outline-info');
                                e.target.disabled = false;
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching batch ID:', error);
                        e.target.textContent = 'Error';
                        e.target.classList.remove('btn-outline-info');
                        e.target.classList.add('btn-danger');
                        setTimeout(() => {
                            e.target.textContent = 'Auto Fill Batch';
                            e.target.classList.remove('btn-danger');
                            e.target.classList.add('btn-outline-info');
                            e.target.disabled = false;
                        }, 2000);
                    });
            } else {
                alert('Please enter a Sample ID first');
            }
        }
    });
    
    // Browse button functionality for document links
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('browse-btn')) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            console.log('Browse button clicked!');
            const targetId = e.target.getAttribute('data-target');
            console.log('Target ID:', targetId);
            const fileInput = document.getElementById(`file-input-${targetId}`);
            const targetInput = document.getElementById(targetId);
            
            console.log('File input found:', !!fileInput);
            console.log('Target input found:', !!targetInput);
            
            if (fileInput && targetInput) {
                // Check if we're in desktop mode before triggering file input
                const isDesktopMode = (typeof pywebview !== 'undefined' && pywebview.api);
                
                if (isDesktopMode) {
                    console.log('Desktop mode detected, using native file dialog directly...');
                    // In desktop mode, call the native dialog directly without the HTML file input
                    pywebview.api.get_file_path('').then(function(fullPath) {
                        if (fullPath && fullPath.trim()) {
                            targetInput.value = fullPath.trim();
                            
                            // Show success feedback
                            const browseBtn = targetInput.parentElement.querySelector('.browse-btn');
                            if (browseBtn) {
                                const originalText = browseBtn.textContent;
                                browseBtn.textContent = '✓ Selected';
                                browseBtn.classList.remove('btn-outline-primary');
                                browseBtn.classList.add('btn-success');
                                setTimeout(() => {
                                    browseBtn.textContent = originalText;
                                    browseBtn.classList.remove('btn-success');
                                    browseBtn.classList.add('btn-outline-primary');
                                }, 2000);
                            }
                            
                            console.log('File selected (desktop mode):', fullPath);
                        }
                    }).catch(function(error) {
                        console.error('Error getting file path:', error);
                        // Fallback to browser file input
                        fileInput.value = '';
                        setTimeout(() => {
                            fileInput.click();
                        }, 10);
                    });
                } else {
                    console.log('Web mode detected, using browser file input...');
                    // Web mode - use browser file input
                    fileInput.value = '';
                    setTimeout(() => {
                        fileInput.click();
                    }, 10);
                }
            } else {
                console.error('File input or target input not found!');
            }
        }
    });
    
    // File input change handler
    document.addEventListener('change', function(e) {
        if (e.target.type === 'file' && e.target.id.startsWith('file-input-')) {
            const targetId = e.target.id.replace('file-input-', '');
            const targetInput = document.getElementById(targetId);
            
            if (targetInput && e.target.files.length > 0) {
                const file = e.target.files[0];
                
                // Try to get the full path if possible (works in some browsers)
                let filePath = '';
                if (file.webkitRelativePath) {
                    filePath = file.webkitRelativePath;
                } else if (file.name) {
                    // For now, just use the filename and let user manually add path if needed
                    filePath = file.name;
                }
                
                // Set the value in the input field
                targetInput.value = filePath;
                
                // Show success feedback
                const browseBtn = targetInput.parentElement.querySelector('.browse-btn');
                if (browseBtn) {
                    const originalText = browseBtn.textContent;
                    browseBtn.textContent = '✓ Selected';
                    browseBtn.classList.remove('btn-outline-primary');
                    browseBtn.classList.add('btn-success');
                    setTimeout(() => {
                        browseBtn.textContent = originalText;
                        browseBtn.classList.remove('btn-success');
                        browseBtn.classList.add('btn-outline-primary');
                    }, 2000);
                }
                
                // Show a helpful message about the file path
                console.log('File selected:', file.name);
                console.log('Note: You may need to manually add the full path to the file location field');
            }
        }
    });
});
</script>
{% endblock %} 