{% set error_messages = [] %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    {% if category == 'danger' or category == 'error' %}
      {% set _ = error_messages.append(message) %}
    {% endif %}
  {% endfor %}
{% endwith %}
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}Lab Manager App{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    /* Smooth fade-out for center alert */
    .center-alert-fade {
        opacity: 0;
        transition: opacity 2s linear;
    }
    
    /* Today button styling */
    .today-btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    
    /* Auto-fill button styling */
    .auto-fill-btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    
    .input-group .form-control {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    /* Compact header styling */
    .compact-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .compact-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .compact-header h2 {
        font-size: 1.25rem;
        font-weight: 500;
    }
    
    .compact-header .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    .compact-header .form-control-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Icon-only buttons for admin actions */
    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    </style>
    {% block head %}{% endblock %}
</head>
<body class="bg-light {% if current_user.is_authenticated %}logged-in{% endif %}">
    <div class="container-fluid py-2 compact-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h1 class="mb-0 me-3"><a href="/" class="text-decoration-none text-dark">WaterIQ Lab Manager</a> <span class="badge bg-secondary">v1.1</span></h1>
                {% if current_user.is_authenticated %}
                    <span class="text-muted me-3">{{ current_user.username }} ({{ current_user.role }})</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if current_user.is_authenticated %}
                    {% if current_user.can_admin() %}
                        <a href="{{ url_for('auth.view_activity_logs') }}" class="btn btn-outline-info btn-sm me-2" title="Activity Logs">
                            <i class="fas fa-list"></i>
                        </a>
                        <a href="{{ url_for('auth.manage_users') }}" class="btn btn-outline-warning btn-sm me-2" title="Manage Users">
                            <i class="fas fa-users"></i>
                        </a>
                        <a href="{{ url_for('admin_schema_viewer') }}" class="btn btn-outline-success btn-sm me-2" title="Database Schema">
                            <i class="fas fa-database"></i>
                        </a>
                    {% endif %}
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-secondary btn-sm">Logout</a>
                {% else %}
                    <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary btn-sm">Login</a>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="container py-3">
        {% include 'alert.html' %}
        {% block content %}{% endblock %}
    </div>
    {# Modal container for AJAX modals #}
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Row</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="editModalBody">
            <!-- Edit form will be loaded here -->
          </div>
        </div>
      </div>
    </div>
    {% if current_user.is_authenticated and current_user.can_admin() %}
    <div id="debug-console-container" style="position:fixed;bottom:0;left:0;width:100%;z-index:1050;">
      <div id="debug-console" style="background:#222;color:#eee;padding:10px 10px 30px 10px;max-height:200px;overflow-y:auto;display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span><strong>Debug Log</strong></span>
          <div>
            <button id="copy-debug-log" class="btn btn-sm btn-secondary me-2" title="Copy log">Copy</button>
            <button id="toggle-debug-console" class="btn btn-sm btn-secondary" title="Minimize">Minimize</button>
          </div>
        </div>
        <pre id="debug-log-text" style="margin:0;white-space:pre-wrap;"></pre>
      </div>
      <button id="show-debug-console" class="btn btn-sm btn-dark" style="position:absolute;right:10px;bottom:10px;display:block;">Show Debug Log</button>
    </div>
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fade out any center alert on page load (for delete or add success)
        const alertDiv = document.getElementById('center-alerts');
        if (alertDiv) {
            setTimeout(() => {
                alertDiv.classList.add('center-alert-fade');
                setTimeout(() => { if (alertDiv) alertDiv.remove(); }, 2000);
            }, 3000);
        }

        // Debug console logic
        const debugConsole = document.getElementById('debug-console');
        const showBtn = document.getElementById('show-debug-console');
        const toggleBtn = document.getElementById('toggle-debug-console');
        const copyBtn = document.getElementById('copy-debug-log');
        const logText = document.getElementById('debug-log-text');
        // Backend debug log (if any)
        var backendDebugLog = {{ debug_log|tojson|default('null', true) }};
        showBtn.addEventListener('click', function() {
            debugConsole.style.display = 'block';
            showBtn.style.display = 'none';
        });
        if (toggleBtn) toggleBtn.addEventListener('click', function() {
            debugConsole.style.display = 'none';
            showBtn.style.display = 'block';
        });
        if (copyBtn) copyBtn.addEventListener('click', function() {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(logText.textContent);
            } else {
                // fallback
                const textarea = document.createElement('textarea');
                textarea.value = logText.textContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        });
        // Helper to log messages
        window.debugLog = function(msg) {
            logText.textContent += (msg + '\n');
            if (debugConsole.style.display === 'block') {
                debugConsole.scrollTop = debugConsole.scrollHeight;
            }
        };
        // If backend debug_log is present, show it in the debug log
        if (backendDebugLog) {
            window.debugLog(backendDebugLog);
            debugConsole.style.display = 'block';
            showBtn.style.display = 'none';
        }
        // Log all flashed error messages to the debug log
        var flashedErrors = {{ error_messages|tojson|safe }};
        flashedErrors.forEach(function(msg) {
            window.debugLog(msg);
            debugConsole.style.display = 'block';
            showBtn.style.display = 'none';
        });
        
        // Today button functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('today-btn')) {
                const targetId = e.target.getAttribute('data-target');
                const targetInput = document.getElementById(targetId);
                if (targetInput) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const todayString = `${year}-${month}-${day}`;
                    targetInput.value = todayString;
                }
            }
        });
        
        // Auto-fill button functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('auto-fill-btn')) {
                const targetId = e.target.getAttribute('data-target');
                const sourceId = e.target.getAttribute('data-source');
                const targetInput = document.getElementById(targetId);
                const sourceInput = document.getElementById(sourceId);
                
                if (targetInput && sourceInput && sourceInput.value.trim()) {
                    const sampleId = sourceInput.value.trim();
                    
                    // Show loading state
                    e.target.textContent = 'Loading...';
                    e.target.disabled = true;
                    
                    fetch(`/api/sample/${sampleId}/batch`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                targetInput.value = data.batch_id;
                                e.target.textContent = '✓ Filled';
                                e.target.classList.remove('btn-outline-info');
                                e.target.classList.add('btn-success');
                                setTimeout(() => {
                                    e.target.textContent = 'Auto Fill Batch';
                                    e.target.classList.remove('btn-success');
                                    e.target.classList.add('btn-outline-info');
                                    e.target.disabled = false;
                                }, 2000);
                            } else {
                                e.target.textContent = 'Not Found';
                                e.target.classList.remove('btn-outline-info');
                                e.target.classList.add('btn-danger');
                                setTimeout(() => {
                                    e.target.textContent = 'Auto Fill Batch';
                                    e.target.classList.remove('btn-danger');
                                    e.target.classList.add('btn-outline-info');
                                    e.target.disabled = false;
                                }, 2000);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching batch ID:', error);
                            e.target.textContent = 'Error';
                            e.target.classList.remove('btn-outline-info');
                            e.target.classList.add('btn-danger');
                            setTimeout(() => {
                                e.target.textContent = 'Auto Fill Batch';
                                e.target.classList.remove('btn-danger');
                                e.target.classList.add('btn-outline-info');
                                e.target.disabled = false;
                            }, 2000);
                        });
                } else {
                    alert('Please enter a Sample ID first');
                }
            }
        });
        
        // Session timeout handling
        let sessionTimeout;
        const SESSION_TIMEOUT_MINUTES = 15;
        const SESSION_TIMEOUT_MS = SESSION_TIMEOUT_MINUTES * 60 * 1000;
        
        function resetSessionTimeout() {
            clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(() => {
                // Show timeout warning
                if (confirm('Your session will expire in 1 minute. Would you like to stay logged in?')) {
                    // Extend session by making a request
                    fetch('/auth/extend-session', { method: 'POST' })
                        .then(response => {
                            if (response.ok) {
                                resetSessionTimeout();
                            } else {
                                window.location.href = '/auth/login';
                            }
                        })
                        .catch(() => {
                            window.location.href = '/auth/login';
                        });
                } else {
                    window.location.href = '/auth/logout';
                }
            }, SESSION_TIMEOUT_MS - 60000); // Warn 1 minute before timeout
        }
        
        // Reset timeout on user activity
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetSessionTimeout, true);
        });
        
        // Initialize session timeout
        if (document.querySelector('body').classList.contains('logged-in')) {
            resetSessionTimeout();
        }
    });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html> 