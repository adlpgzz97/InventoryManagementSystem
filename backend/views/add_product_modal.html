{% if error_message %}
<div class="alert alert-danger">{{ error_message }}</div>
{% endif %}

<form method="post" id="addProductForm" action="{{ url_for('products.add_product') }}?modal=1">
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="sku" class="form-label">SKU <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="sku" name="sku" 
                       placeholder="e.g., SKU001" required>
                <small class="form-text text-muted">Must be unique</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="name" class="form-label">Product Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="name" name="name" 
                       placeholder="e.g., Widget A" required>
            </div>
        </div>
    </div>
    
    <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <textarea class="form-control" id="description" name="description" rows="3" 
                  placeholder="Enter product description..."></textarea>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <div class="mb-3">
                <label for="dimensions" class="form-label">Dimensions</label>
                <input type="text" class="form-control" id="dimensions" name="dimensions" 
                       placeholder="e.g., 10x5x2 cm">
            </div>
        </div>
        <div class="col-md-4">
            <div class="mb-3">
                <label for="weight" class="form-label">Weight (kg)</label>
                <input type="number" step="0.01" min="0" class="form-control" id="weight" name="weight" 
                       placeholder="0.00">
            </div>
        </div>
        <div class="col-md-4">
            <div class="mb-3">
                <label for="category_id" class="form-label">Category</label>
                <div class="input-group">
                    <select class="form-select" id="category_id" name="category_id">
                        <option value="">Select Category</option>
                        {% if categories %}
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.description or category.code }}</option>
                            {% endfor %}
                        {% else %}
                            <option value="" disabled>No categories available</option>
                        {% endif %}
                    </select>
                    <button class="btn btn-outline-primary" type="button" id="add-category-btn" title="Add New Category">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <small class="form-text text-muted">Choose or create a category</small>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="barcode" class="form-label">Barcode</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="barcode" name="barcode" 
                           placeholder="e.g., 1234567890123">
                    <button class="btn btn-outline-secondary" type="button" id="scan-barcode-btn" title="Scan Barcode">
                        <i class="fas fa-qrcode"></i>
                    </button>
                    <button class="btn btn-outline-info" type="button" id="generate-barcode-btn" title="Generate Random Barcode">
                        <i class="fas fa-magic"></i>
                    </button>
                </div>
                <small class="form-text text-muted">Scan existing or generate new barcode</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="picture_url" class="form-label">Picture URL</label>
                <input type="url" class="form-control" id="picture_url" name="picture_url" 
                       placeholder="https://example.com/image.jpg">
            </div>
        </div>
    </div>
    
    <div class="mb-3">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="batch_tracked" name="batch_tracked">
            <label class="form-check-label" for="batch_tracked">
                <strong>Enable Batch Tracking</strong>
            </label>
            <div class="form-text">
                When enabled, each stock receipt will create separate inventory records with batch ID and expiry date. 
                When disabled, stock quantities are combined in the same location.
            </div>
        </div>
    </div>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Quick Tip:</strong> SKU must be unique. Choose a naming convention like 
        <code>SKU001</code>, <code>WIDGET-A</code>, or <code>PROD-2024-001</code>.
    </div>
    
    <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancel
        </button>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-plus me-2"></i>Add Product
        </button>
    </div>
</form>

<p class="mt-2 text-muted"><span class="text-danger">*</span> Required field</p>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add category button functionality
    const addCategoryBtn = document.getElementById('add-category-btn');
    console.log('Add category button found:', addCategoryBtn);
    if (addCategoryBtn) {
        addCategoryBtn.addEventListener('click', function() {
            console.log('Add category button clicked');
            showAddCategoryModal();
        });
    } else {
        console.error('Add category button not found!');
    }
    
    // Barcode scanning functionality
    const scanBarcodeBtn = document.getElementById('scan-barcode-btn');
    const generateBarcodeBtn = document.getElementById('generate-barcode-btn');
    const barcodeInput = document.getElementById('barcode');
    
    if (scanBarcodeBtn && window.barcodeScanner) {
        scanBarcodeBtn.addEventListener('click', function() {
            window.barcodeScanner.show((barcode, scanData) => {
                barcodeInput.value = barcode;
                
                // Show success feedback
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    Barcode scanned: <strong>${barcode}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                barcodeInput.parentNode.insertAdjacentElement('afterend', alertDiv);
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            });
        });
    }
    
    if (generateBarcodeBtn) {
        generateBarcodeBtn.addEventListener('click', function() {
            // Generate a random EAN-13 barcode
            const randomBarcode = generateEAN13();
            barcodeInput.value = randomBarcode;
            
            // Show feedback
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info alert-dismissible fade show mt-2';
            alertDiv.innerHTML = `
                <i class="fas fa-magic me-2"></i>
                Generated barcode: <strong>${randomBarcode}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            barcodeInput.parentNode.insertAdjacentElement('afterend', alertDiv);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        });
    }
    
    function generateEAN13() {
        // Generate 12 random digits
        let barcode = '';
        for (let i = 0; i < 12; i++) {
            barcode += Math.floor(Math.random() * 10);
        }
        
        // Calculate check digit
        let sum = 0;
        for (let i = 0; i < 12; i++) {
            const digit = parseInt(barcode[i]);
            sum += (i % 2 === 0) ? digit : digit * 3;
        }
        const checkDigit = (10 - (sum % 10)) % 10;
        
        return barcode + checkDigit;
    }
    
    
    // Show add category modal
    function showAddCategoryModal() {
        console.log('showAddCategoryModal called');
        // Create modal HTML
        const modalHtml = `
            <div class="modal fade" id="addCategoryModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-plus me-2"></i>Add New Category
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addCategoryForm">
                                <div class="mb-3">
                                    <label for="category_code" class="form-label">Category Code <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="category_code" name="code" 
                                           placeholder="e.g., ELECTRONICS" required>
                                    <small class="form-text text-muted">Use uppercase letters, numbers, and underscores only</small>
                                </div>
                                <div class="mb-3">
                                    <label for="category_description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="category_description" name="description" 
                                           placeholder="e.g., Electronic devices and components">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="save-category-btn">
                                <i class="fas fa-save me-2"></i>Save Category
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('addCategoryModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modalElement = document.getElementById('addCategoryModal');
        console.log('Modal element created:', modalElement);
        const modal = new bootstrap.Modal(modalElement);
        console.log('Bootstrap modal instance created:', modal);
        modal.show();
        console.log('Modal show() called');
        
        // Handle save button
        document.getElementById('save-category-btn').addEventListener('click', function() {
            saveNewCategory();
        });
        
        // Handle form submission on Enter
        document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveNewCategory();
        });
    }
    
    // Save new category
    function saveNewCategory() {
        console.log('saveNewCategory called');
        const code = document.getElementById('category_code').value.trim().toUpperCase();
        const description = document.getElementById('category_description').value.trim();
        console.log('Category code:', code, 'Description:', description);
        
        if (!code) {
            alert('Please enter a category code.');
            return;
        }
        
        // Validate code format (uppercase letters, numbers, underscores only)
        if (!/^[A-Z0-9_]+$/.test(code)) {
            alert('Category code must contain only uppercase letters, numbers, and underscores.');
            return;
        }
        
        // Send request to create category
        console.log('Sending API request to create category');
        fetch('/api/categories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                description: description
            })
        })
        .then(response => {
            console.log('API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API response data:', data);
            if (data.success) {
                // Close category modal
                const categoryModal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
                categoryModal.hide();
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    Category "${code}" created successfully! Please refresh the page to see it in the dropdown.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.getElementById('addProductForm').insertAdjacentElement('afterend', alertDiv);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            } else {
                alert('Error creating category: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error creating category:', error);
            console.error('Error details:', error.message);
            alert('Error creating category. Please try again. Check console for details.');
        });
    }
});
</script>
