{% extends "base.html" %}

{% block title %}{{ warehouse.name }} - Locations{% endblock %}

{% block content %}
<style>
.hierarchy-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.area-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.area-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.area-header:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
}

.area-header.collapsed {
    border-radius: 8px;
}

 .racks-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
     gap: 20px;
     padding: 20px;
 }
 
 .rack-card {
     background: white;
     border: 1px solid #dee2e6;
     border-radius: 8px;
     box-shadow: 0 2px 4px rgba(0,0,0,0.1);
     transition: all 0.3s ease;
 }
 
 .rack-card:hover {
     box-shadow: 0 4px 8px rgba(0,0,0,0.15);
     transform: translateY(-2px);
 }

.rack-header {
    background: #e9ecef;
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.rack-header:hover {
    background: #dee2e6;
}

.rack-header.collapsed {
    margin-bottom: 0;
}

 .rack-layout {
     margin-top: 15px;
     padding: 15px;
     background: #f8f9fa;
     border-radius: 8px;
     border: 1px solid #e9ecef;
 }
 
 .rack-visualization {
     display: flex;
     flex-direction: column;
     gap: 8px;
 }
 
 .level-section {
     margin-bottom: 15px;
     padding: 12px;
     background: white;
     border: 1px solid #e9ecef;
     border-radius: 6px;
 }
 
 .level-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 10px;
     padding-bottom: 8px;
     border-bottom: 1px solid #f8f9fa;
 }
 
 .level-title h6 {
     color: #495057;
     font-weight: 600;
     margin-bottom: 2px;
 }
 
 .level-title small {
     font-size: 0.8rem;
     color: #6c757d;
 }
 
 .level-stats {
     display: flex;
     align-items: center;
 }
 
 .level-bins-container {
     display: flex;
     flex-wrap: wrap;
     gap: 8px;
     align-items: flex-start;
 }
 
 .bin-item {
     background: white;
     border: 2px solid #dee2e6;
     border-radius: 6px;
     padding: 8px 12px;
     font-size: 0.85rem;
     display: flex;
     align-items: center;
     gap: 8px;
     min-width: 120px;
     max-width: 200px;
     transition: all 0.3s ease;
     position: relative;
 }
 
 .bin-item:hover {
     background: #f8f9fa;
     border-color: #007bff;
     transform: translateY(-1px);
     box-shadow: 0 2px 4px rgba(0,0,0,0.1);
 }
 
 .bin-item.occupied {
     background: #d4edda;
     border-color: #28a745;
 }
 
 .bin-item.empty {
     background: #f8d7da;
     border-color: #dc3545;
 }
 
 .bin-content {
     flex: 1;
     min-width: 0;
 }
 
 .bin-content strong {
     display: block;
     font-size: 0.9rem;
     color: #495057;
 }
 
 .bin-content small {
     display: block;
     line-height: 1.2;
 }
 
 .bin-status {
     display: flex;
     align-items: center;
     justify-content: center;
 }
 
 .status-indicator {
     width: 12px;
     height: 12px;
     border-radius: 50%;
     border: 2px solid white;
 }
 
 .status-indicator.occupied {
     background: #28a745;
 }
 
 .status-indicator.empty {
     background: #dc3545;
 }
 
 .empty-location {
     display: flex;
     align-items: center;
     justify-content: center;
     padding: 8px 12px;
     background: #f8f9fa;
     border: 1px solid #dee2e6;
     border-radius: 6px;
     min-width: 120px;
     max-width: 200px;
 }
 
 .empty-text {
     color: #6c757d;
     font-size: 0.85rem;
     font-weight: 500;
 }
 
 .rack-utilization {
     margin-top: 15px;
     padding-top: 15px;
     border-top: 1px solid #e9ecef;
 }



.stats-badge {
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 12px;
    font-weight: 600;
}

.stats-badge.primary {
    background: #007bff;
    color: white;
}

.stats-badge.success {
    background: #28a745;
    color: white;
}

.stats-badge.warning {
    background: #ffc107;
    color: #212529;
}

.stats-badge.danger {
    background: #dc3545;
    color: white;
}

.collapse-icon {
    transition: transform 0.3s ease;
}

.collapse-icon.rotated {
    transform: rotate(180deg);
}

.utilization-bar {
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    margin-top: 5px;
}

.utilization-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.utilization-fill.low {
    background: #28a745;
}

.utilization-fill.medium {
    background: #ffc107;
}

.utilization-fill.high {
    background: #dc3545;
}

.hierarchy-summary {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.summary-item {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.summary-number {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.summary-label {
    font-size: 0.9rem;
    color: #6c757d;
}
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">
            <i class="fas fa-sitemap me-2"></i>
            {{ warehouse.name }} - Locations
        </h1>
        <p class="text-muted mb-0">
            <i class="fas fa-map-marker-alt me-1"></i>
            {{ warehouse.address or 'No address specified' }}
            {% if warehouse.code %}
                <span class="badge bg-secondary ms-2">{{ warehouse.code }}</span>
            {% endif %}
        </p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('warehouses.warehouses_list') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Warehouses
            </a>
            <button class="btn btn-sm btn-outline-primary" onclick="expandAll()">
                <i class="fas fa-expand me-1"></i> Expand All
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="collapseAll()">
                <i class="fas fa-compress me-1"></i> Collapse All
            </button>
        </div>
    </div>
</div>

<!-- Locations Summary -->
<div class="hierarchy-summary">
    <h5><i class="fas fa-chart-bar me-2"></i>Locations Overview</h5>
    <div class="summary-grid">
        <div class="summary-item">
            <div class="summary-number text-primary">{{ hierarchical_data.total_locations }}</div>
            <div class="summary-label">Total Locations</div>
        </div>
        <div class="summary-item">
            <div class="summary-number text-info">{{ hierarchical_data.total_bins }}</div>
            <div class="summary-label">Total Bins</div>
        </div>
        <div class="summary-item">
            <div class="summary-number text-success">{{ hierarchical_data.occupied_bins }}</div>
            <div class="summary-label">Occupied Bins</div>
        </div>
        <div class="summary-item">
            <div class="summary-number text-warning">{{ hierarchical_data.total_bins - hierarchical_data.occupied_bins }}</div>
            <div class="summary-label">Available Bins</div>
        </div>
        <div class="summary-item">
            <div class="summary-number text-secondary">{{ hierarchical_data.areas|length }}</div>
            <div class="summary-label">Storage Areas</div>
        </div>
        <div class="summary-item">
            {% set utilization = (hierarchical_data.occupied_bins / hierarchical_data.total_bins * 100) if hierarchical_data.total_bins > 0 else 0 %}
            <div class="summary-number {% if utilization > 80 %}text-danger{% elif utilization > 60 %}text-warning{% else %}text-success{% endif %}">
                {{ "%.1f"|format(utilization) }}%
            </div>
            <div class="summary-label">Utilization</div>
        </div>
    </div>
</div>

<!-- Locations Structure -->
<div class="hierarchy-container">
    {% if hierarchical_data.areas %}
        {% for area_code, area in hierarchical_data.areas.items()|sort %}
        <div class="area-card">
            <div class="area-header" onclick="toggleArea('{{ area_code }}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-building me-2"></i>
                            {{ area.name }}
                        </h5>
                        <small>
                            {{ area.total_locations }} locations, 
                            {{ area.total_bins }} bins, 
                            {{ area.occupied_bins }} occupied
                        </small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="stats-badge primary me-2">
                            {{ area.total_bins - area.occupied_bins }} available
                        </span>
                        <i class="fas fa-chevron-down collapse-icon" id="area-icon-{{ area_code }}"></i>
                    </div>
                </div>
            </div>
            
                         <div class="area-content" id="area-content-{{ area_code }}">
                 <div class="racks-grid">
                     {% for rack_code, rack in area.racks.items()|sort %}
                     <div class="rack-card">
                         <div class="rack-header" onclick="toggleRack('{{ area_code }}-{{ rack_code }}')">
                             <div class="d-flex justify-content-between align-items-center">
                                 <div>
                                     <h6 class="mb-0">
                                         <i class="fas fa-layer-group me-2"></i>
                                         {{ rack.name }}
                                     </h6>
                                     <small>
                                         {{ rack.total_locations }} locations, 
                                         {{ rack.total_bins }} bins, 
                                         {{ rack.occupied_bins }} occupied
                                     </small>
                                 </div>
                                 <div class="d-flex align-items-center">
                                     <span class="stats-badge {% if rack.occupied_bins > 0 %}success{% else %}warning{% endif %} me-2">
                                         {{ rack.occupied_bins }}/{{ rack.total_bins }}
                                     </span>
                                     {% if rack.total_bins == 0 %}
                                     <button class="btn btn-sm btn-outline-danger me-2" 
                                             onclick="deleteRack('{{ area_code }}', '{{ rack_code }}', '{{ rack.name }}')"
                                             title="Delete empty rack (no bins)">
                                         <i class="fas fa-trash"></i>
                                     </button>
                                     {% endif %}
                                     <i class="fas fa-chevron-down collapse-icon" id="rack-icon-{{ area_code }}-{{ rack_code }}"></i>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="rack-content" id="rack-content-{{ area_code }}-{{ rack_code }}">
                             <div class="rack-layout">
                                 <div class="rack-visualization">
                                     {% set levels = rack.levels.items()|list|sort(attribute=0, reverse=true) %}
                                     {% for level_code, level in levels %}
                                                                           <div class="level-section">
                                          <div class="level-header">
                                              <div class="level-title">
                                                  <h6 class="mb-0">{{ level.name }}</h6>
                                                  <small class="text-muted">{{ level.bins[0].full_code if level.bins else 'No location code' }}</small>
                                              </div>
                                              <div class="level-stats">
                                                  <span class="stats-badge {% if level.occupied_bins > 0 %}success{% else %}warning{% endif %}">
                                                      {{ level.occupied_bins }}/{{ level.total_bins }}
                                                  </span>
                                              </div>
                                          </div>
                                          <div class="level-bins-container">
                                              {% if level.bins %}
                                                  {% for bin in level.bins %}
                                                      {% if bin.is_empty_location %}
                                                          <div class="empty-location">
                                                              <span class="empty-text">Empty</span>
                                                          </div>
                                                      {% else %}
                                                          <div class="bin-item {% if bin.occupied %}occupied{% else %}empty{% endif %}" 
                                                               style="cursor: pointer;" 
                                                               onclick="binDetailsManager.showBinDetails('{{ bin.code }}')"
                                                               title="Click to view bin details">
                                                              <div class="bin-content">
                                                                  <strong>{{ bin.code }}</strong>
                                                                  <br>
                                                                  <small class="text-muted">{{ bin.full_code }}</small>
                                                                  {% if bin.stock_count > 0 %}
                                                                  <br>
                                                                  <small class="text-info">{{ bin.stock_count }} items ({{ bin.total_stock_quantity }} qty)</small>
                                                                  {% endif %}
                                                              </div>
                                                              <div class="bin-status">
                                                                  <span class="status-indicator {% if bin.occupied %}occupied{% else %}empty{% endif %}"></span>
                                                              </div>
                                                          </div>
                                                      {% endif %}
                                                  {% endfor %}
                                              {% else %}
                                                  <div class="empty-location">
                                                      <span class="empty-text">Empty</span>
                                                  </div>
                                              {% endif %}
                                          </div>
                                      </div>
                                     {% endfor %}
                                 </div>

                             </div>
                         </div>
                     </div>
                     {% endfor %}
                 </div>
             </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Locations</h4>
            <p class="text-muted">This warehouse doesn't have any locations configured yet.</p>
            <a href="{{ url_for('warehouses.edit_warehouse', warehouse_id=warehouse.id) }}?modal=1" 
               class="btn btn-primary">
                <i class="fas fa-cog me-1"></i> Edit Warehouse
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
{% include 'bin_details_modal.html' %}

<!-- Delete Rack Confirmation Modal -->
<div class="modal fade" id="deleteRackModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                    Delete Rack
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
                <p>Are you sure you want to delete the rack <strong id="deleteRackName"></strong>?</p>
                <p class="text-muted">This will permanently remove all locations associated with this rack. This rack has no bins, so it's safe to delete.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteRack">
                    <i class="fas fa-trash me-1"></i> Delete Rack
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle area visibility
function toggleArea(areaCode) {
    const content = document.getElementById(`area-content-${areaCode}`);
    const icon = document.getElementById(`area-icon-${areaCode}`);
    const header = content.previousElementSibling;
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.classList.remove('rotated');
        header.classList.remove('collapsed');
    } else {
        content.style.display = 'none';
        icon.classList.add('rotated');
        header.classList.add('collapsed');
    }
}

// Toggle rack visibility
function toggleRack(rackId) {
    const content = document.getElementById(`rack-content-${rackId}`);
    const icon = document.getElementById(`rack-icon-${rackId}`);
    const header = content.previousElementSibling;
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.classList.remove('rotated');
        header.classList.remove('collapsed');
    } else {
        content.style.display = 'none';
        icon.classList.add('rotated');
        header.classList.add('collapsed');
    }
}

// Expand all sections
function expandAll() {
    const areas = document.querySelectorAll('.area-content');
    const racks = document.querySelectorAll('.rack-content');
    const areaIcons = document.querySelectorAll('.area-header .collapse-icon');
    const rackIcons = document.querySelectorAll('.rack-header .collapse-icon');
    const areaHeaders = document.querySelectorAll('.area-header');
    const rackHeaders = document.querySelectorAll('.rack-header');
    
    areas.forEach(area => area.style.display = 'block');
    racks.forEach(rack => rack.style.display = 'block');
    areaIcons.forEach(icon => icon.classList.remove('rotated'));
    rackIcons.forEach(icon => icon.classList.remove('rotated'));
    areaHeaders.forEach(header => header.classList.remove('collapsed'));
    rackHeaders.forEach(header => header.classList.remove('collapsed'));
}

// Collapse all sections
function collapseAll() {
    const areas = document.querySelectorAll('.area-content');
    const racks = document.querySelectorAll('.rack-content');
    const areaIcons = document.querySelectorAll('.area-header .collapse-icon');
    const rackIcons = document.querySelectorAll('.rack-header .collapse-icon');
    const areaHeaders = document.querySelectorAll('.area-header');
    const rackHeaders = document.querySelectorAll('.rack-header');
    
    areas.forEach(area => area.style.display = 'none');
    racks.forEach(rack => rack.style.display = 'none');
    areaIcons.forEach(icon => icon.classList.add('rotated'));
    rackIcons.forEach(icon => icon.classList.add('rotated'));
    areaHeaders.forEach(header => header.classList.add('collapsed'));
    rackHeaders.forEach(header => header.classList.add('collapsed'));
}

// Delete rack functionality
let currentRackToDelete = null;

function deleteRack(areaCode, rackCode, rackName) {
    currentRackToDelete = { areaCode, rackCode, rackName };
    document.getElementById('deleteRackName').textContent = rackName;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteRackModal'));
    modal.show();
}

async function confirmDeleteRack() {
    if (!currentRackToDelete) return;
    
    const { areaCode, rackCode } = currentRackToDelete;
    const submitBtn = document.getElementById('confirmDeleteRack');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch(`/warehouses/api/rack/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                area_code: areaCode,
                rack_code: rackCode
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteRackModal'));
            modal.hide();
            
            // Remove the rack from the UI
            const rackCard = document.querySelector(`[onclick*="${areaCode}-${rackCode}"]`).closest('.rack-card');
            if (rackCard) {
                rackCard.remove();
            }
            
            // Show success message
            showSuccessMessage(`Rack ${currentRackToDelete.rackName} has been deleted successfully.`);
            
            // Refresh the page to update statistics
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            alert('Error: ' + (data.error || 'Failed to delete rack'));
        }
    } catch (error) {
        console.error('Delete rack error:', error);
        alert('Network error occurred');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        currentRackToDelete = null;
    }
}

function showSuccessMessage(message) {
    // Create a temporary success alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

 // Initialize page
 document.addEventListener('DOMContentLoaded', function() {
     // Add hover effects for better interactivity
     const rackCards = document.querySelectorAll('.rack-card');
     rackCards.forEach(card => {
         card.addEventListener('mouseenter', function() {
             this.style.transform = 'translateY(-2px)';
         });
         card.addEventListener('mouseleave', function() {
             this.style.transform = 'translateY(0)';
         });
     });
     
     // Add event listener for delete rack confirmation
     document.getElementById('confirmDeleteRack').addEventListener('click', confirmDeleteRack);
 });
</script>
{% endblock %}
