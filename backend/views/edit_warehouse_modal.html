{% if error_message %}
<div class="alert alert-danger">{{ error_message }}</div>
{% endif %}

<form method="post" id="editWarehouseForm" action="{{ url_for('edit_warehouse', warehouse_id=warehouse.id) }}?modal=1">
    <div class="mb-3">
        <label for="name" class="form-label">Warehouse Name <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="name" name="name" 
               value="{{ warehouse.name }}" required>
    </div>
    
    <div class="mb-3">
        <label for="address" class="form-label">Address</label>
        <textarea class="form-control" id="address" name="address" rows="3" 
                  placeholder="Enter warehouse address">{{ warehouse.address or '' }}</textarea>
        <small class="form-text text-muted">Full address including street, city, state, postal code</small>
    </div>
    

    
    <!-- Hierarchical Storage Structure Section -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-sitemap me-2"></i>Storage Structure (Areas → Racks → Levels)</h6>
            <button type="button" class="btn btn-success btn-sm" id="addAreaBtn">
                <i class="fas fa-plus me-1"></i>Add Area
            </button>
        </div>
        <div class="card-body">
            <div id="areasList">
                <!-- Areas will be dynamically added here -->
            </div>
            <div id="noAreasMessage" class="text-center text-muted py-4">
                <i class="fas fa-sitemap fa-2x mb-2"></i>
                <p>No storage areas configured yet. Click "Add Area" to create the hierarchical structure.</p>
            </div>
        </div>
    </div>
    
    <!-- Hidden inputs for form submission -->
    <input type="hidden" id="hierarchicalData" name="hierarchical_data" value="">
    <input type="hidden" id="createLocations" name="create_locations" value="true">
    <input type="hidden" id="existingLocations" name="existing_locations" value='{{ warehouse.locations|tojson|safe if warehouse.locations else "[]" }}'>
    
    <!-- Debug info (remove in production) -->
    <script>
        console.log('Warehouse data:', {{ warehouse|tojson|safe }});
        console.log('Locations data:', {{ warehouse.locations|tojson|safe }});
        console.log('Locations data type:', typeof {{ warehouse.locations|tojson|safe }});
        console.log('Locations data length:', {{ warehouse.locations|length }});
        console.log('Raw existing locations value:', document.getElementById('existingLocations').value);
    </script>

    <script>
        // Hierarchical Storage Structure Management
        let areasData = [];
        let areaCounter = 0;
        let rackCounter = 0;
        let levelCounter = 0;

        // Initialize existing data if available
        document.addEventListener('DOMContentLoaded', function() {
            const existingLocations = {{ warehouse.hierarchical_locations|tojson|safe if warehouse.hierarchical_locations else '{}' }};
            if (existingLocations && Object.keys(existingLocations).length > 0) {
                loadExistingHierarchicalData(existingLocations);
            }
            updateHierarchicalData();
        });

        function loadExistingHierarchicalData(hierarchicalData) {
            areasData = [];
            for (const [areaCode, area] of Object.entries(hierarchicalData)) {
                const areaData = {
                    id: areaCode,
                    name: area.name,
                    code: area.code,
                    racks: []
                };
                
                for (const [rackCode, rack] of Object.entries(area.racks)) {
                    const rackData = {
                        id: rackCode,
                        name: rack.name,
                        code: rack.code,
                        levels: []
                    };
                    
                    for (const [levelCode, level] of Object.entries(rack.levels)) {
                        rackData.levels.push({
                            id: levelCode,
                            name: level.name,
                            code: levelCode,
                            location_id: level.location_id,
                            full_code: level.full_code,
                            bin_count: level.bin_count,
                            occupied_bins: level.occupied_bins || 0
                        });
                    }
                    areaData.racks.push(rackData);
                }
                areasData.push(areaData);
            }
            renderAreas();
        }

        function renderAreas() {
            const areasList = document.getElementById('areasList');
            const noAreasMessage = document.getElementById('noAreasMessage');
            
            if (areasData.length === 0) {
                areasList.innerHTML = '';
                noAreasMessage.style.display = 'block';
                return;
            }
            
            noAreasMessage.style.display = 'none';
            areasList.innerHTML = '';
            
            areasData.forEach((area, areaIndex) => {
                const areaElement = createAreaElement(area, areaIndex);
                areasList.appendChild(areaElement);
            });
        }

        function createAreaElement(area, areaIndex) {
            const areaDiv = document.createElement('div');
            areaDiv.className = 'area-row mb-3';
            areaDiv.innerHTML = `
                <div class="area-header d-flex align-items-center mb-2">
                    <i class="bi bi-grid-3x3-gap me-2 text-primary"></i>
                    <input type="text" class="form-control form-control-sm me-2" 
                           placeholder="Area Name" value="${area.name}" 
                           onchange="updateAreaName(${areaIndex}, this.value)" style="width: 150px;">
                    <input type="text" class="form-control form-control-sm me-2" 
                           placeholder="Area Code" value="${area.code}" 
                           onchange="updateAreaCode(${areaIndex}, this.value)" style="width: 100px;">
                    <button type="button" class="btn btn-info btn-sm me-2" onclick="addRack(${areaIndex})">
                        <i class="fas fa-plus"></i> Add Rack
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeArea(${areaIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="racks-container ms-3">
                    ${area.racks.map((rack, rackIndex) => createRackHTML(areaIndex, rack, rackIndex)).join('')}
                </div>
            `;
            return areaDiv;
        }

        function createRackHTML(areaIndex, rack, rackIndex) {
            return `
                <div class="rack-row mb-2">
                    <div class="rack-header d-flex align-items-center mb-1">
                        <i class="bi bi-box me-2 text-info"></i>
                        <input type="text" class="form-control form-control-sm me-2" 
                               placeholder="Rack Name" value="${rack.name}" 
                               onchange="updateRackName(${areaIndex}, ${rackIndex}, this.value)" style="width: 120px;">
                        <input type="text" class="form-control form-control-sm me-2" 
                               placeholder="Rack Code" value="${rack.code}" 
                               onchange="updateRackCode(${areaIndex}, ${rackIndex}, this.value)" style="width: 80px;">
                        <button type="button" class="btn btn-success btn-sm me-2" onclick="addLevel(${areaIndex}, ${rackIndex})">
                            <i class="fas fa-plus"></i> Add Level
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeRack(${areaIndex}, ${rackIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="levels-container ms-3">
                        ${rack.levels.map((level, levelIndex) => createLevelHTML(areaIndex, rackIndex, level, levelIndex)).join('')}
                    </div>
                </div>
            `;
        }

                                function createLevelHTML(areaIndex, rackIndex, level, levelIndex) {
            const binCount = level.bin_count || 0;
            const occupiedBins = level.occupied_bins || 0;
            const isOccupied = occupiedBins > 0;
            const badgeClass = isOccupied ? 'bg-warning' : 'bg-success';
            const badgeText = isOccupied ? `${occupiedBins}/${binCount} bin(s) occupied` : `${binCount} bin(s)`;
            
            return `
                <div class="level-row mb-1 ${isOccupied ? 'occupied-location' : ''}">
                    <div class="level-item d-flex align-items-center">
                        <i class="bi bi-layers me-2 text-success"></i>
                        <input type="text" class="form-control form-control-sm me-2" 
                               placeholder="Level Name" value="${level.name}" 
                               onchange="updateLevelName(${areaIndex}, ${rackIndex}, ${levelIndex}, this.value)" style="width: 100px;">
                        <input type="text" class="form-control form-control-sm me-2" 
                               placeholder="Level Code" value="${level.code}" 
                               onchange="updateLevelCode(${areaIndex}, ${rackIndex}, ${levelIndex}, this.value)" style="width: 60px;">
                        <span class="badge ${badgeClass} me-2">${badgeText}</span>
                        <small class="text-muted me-2">(${level.full_code || ''})</small>
                        ${isOccupied ? '<span class="occupied-badge me-2">OCCUPIED</span>' : ''}
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeLevel(${areaIndex}, ${rackIndex}, ${levelIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Add Area button handler
        document.getElementById('addAreaBtn').addEventListener('click', function() {
            const newArea = {
                id: `A${++areaCounter}`,
                name: `Area ${areaCounter}`,
                code: `A${areaCounter.toString().padStart(2, '0')}`,
                racks: []
            };
            areasData.push(newArea);
            renderAreas();
            updateHierarchicalData();
        });

        function addRack(areaIndex) {
            const newRack = {
                id: `R${++rackCounter}`,
                name: `Rack ${rackCounter}`,
                code: `R${rackCounter.toString().padStart(2, '0')}`,
                levels: []
            };
            areasData[areaIndex].racks.push(newRack);
            renderAreas();
            updateHierarchicalData();
        }

        function addLevel(areaIndex, rackIndex) {
            const newLevel = {
                id: `L${++levelCounter}`,
                name: `Level ${levelCounter}`,
                code: `L${levelCounter}`,
                location_id: null,
                full_code: '',
                bin_count: 0
            };
            areasData[areaIndex].racks[rackIndex].levels.push(newLevel);
            renderAreas();
            updateHierarchicalData();
        }

        // Update functions
        function updateAreaName(areaIndex, name) {
            areasData[areaIndex].name = name;
            updateHierarchicalData();
        }

        function updateAreaCode(areaIndex, code) {
            areasData[areaIndex].code = code;
            updateHierarchicalData();
        }

        function updateRackName(areaIndex, rackIndex, name) {
            areasData[areaIndex].racks[rackIndex].name = name;
            updateHierarchicalData();
        }

        function updateRackCode(areaIndex, rackIndex, code) {
            areasData[areaIndex].racks[rackIndex].code = code;
            updateHierarchicalData();
        }

        function updateLevelName(areaIndex, rackIndex, levelIndex, name) {
            areasData[areaIndex].racks[rackIndex].levels[levelIndex].name = name;
            updateHierarchicalData();
        }

        function updateLevelCode(areaIndex, rackIndex, levelIndex, code) {
            areasData[areaIndex].racks[rackIndex].levels[levelIndex].code = code;
            updateHierarchicalData();
        }

        // Remove functions
        function removeArea(areaIndex) {
            const area = areasData[areaIndex];
            
            // Check if area has racks with levels that have occupied bins
            let totalOccupiedBins = 0;
            area.racks.forEach(rack => {
                rack.levels.forEach(level => {
                    totalOccupiedBins += level.occupied_bins || 0;
                });
            });
            
            if (totalOccupiedBins > 0) {
                if (!confirm(`This area has ${totalOccupiedBins} occupied bin(s) with stock across its racks and levels. Are you sure you want to remove it? This will also remove all associated bins and stock items.`)) {
                    return;
                }
            }
            
            areasData.splice(areaIndex, 1);
            renderAreas();
            updateHierarchicalData();
        }

        function removeRack(areaIndex, rackIndex) {
            const rack = areasData[areaIndex].racks[rackIndex];
            
            // Check if rack has levels with occupied bins
            let totalOccupiedBins = 0;
            rack.levels.forEach(level => {
                totalOccupiedBins += level.occupied_bins || 0;
            });
            
            if (totalOccupiedBins > 0) {
                if (!confirm(`This rack has ${totalOccupiedBins} occupied bin(s) with stock across its levels. Are you sure you want to remove it? This will also remove all associated bins and stock items.`)) {
                    return;
                }
            }
            
            areasData[areaIndex].racks.splice(rackIndex, 1);
            renderAreas();
            updateHierarchicalData();
        }

        function removeLevel(areaIndex, rackIndex, levelIndex) {
            const level = areasData[areaIndex].racks[rackIndex].levels[levelIndex];
            
            // Check if level has occupied bins
            const occupiedBins = level.occupied_bins || 0;
            if (occupiedBins > 0) {
                if (!confirm(`This level has ${occupiedBins} occupied bin(s) with stock. Are you sure you want to remove it? This will also remove all associated bins and stock items.`)) {
                    return;
                }
            }
            
            areasData[areaIndex].racks[rackIndex].levels.splice(levelIndex, 1);
            renderAreas();
            updateHierarchicalData();
        }

        function updateHierarchicalData() {
            const hierarchicalData = {};
            
            areasData.forEach(area => {
                hierarchicalData[area.code] = {
                    name: area.name,
                    code: area.code,
                    racks: {}
                };
                
                area.racks.forEach(rack => {
                    hierarchicalData[area.code].racks[rack.code] = {
                        name: rack.name,
                        code: rack.code,
                        levels: {}
                    };
                    
                    rack.levels.forEach(level => {
                        hierarchicalData[area.code].racks[rack.code].levels[level.code] = {
                            name: level.name,
                            code: level.code,
                            location_id: level.location_id,
                            full_code: level.full_code,
                            bin_count: level.bin_count,
                            occupied_bins: level.occupied_bins || 0
                        };
                    });
                });
            });
            
            document.getElementById('hierarchicalData').value = JSON.stringify(hierarchicalData);
        }

        // Form submission
        document.getElementById('editWarehouseForm').addEventListener('submit', function(e) {
            updateHierarchicalData();
        });
    </script>
    
    <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-danger delete-btn" 
                data-type="warehouse" 
                data-id="{{ warehouse.id }}"
                data-name="{{ warehouse.name }}">
            <i class="fas fa-trash me-2"></i>Delete Warehouse
        </button>
        <div>
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                <i class="fas fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Save Changes
            </button>
        </div>
    </div>
</form>

<p class="mt-2 text-muted"><span class="text-danger">*</span> Required field</p>

<style>
.aisle-row {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}

.aisle-row:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.aisle-row .aisle-name {
    font-weight: 600;
    color: #495057;
    min-width: 60px;
}

.bin-counter {
    display: flex;
    align-items: center;
    gap: 8px;
}

.bin-counter input {
    text-align: center;
    width: 60px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 4px 8px;
}

/* Remove browser default spinners from number inputs */
.bin-counter input[type="number"]::-webkit-outer-spin-button,
.bin-counter input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.bin-counter input[type="number"] {
    -moz-appearance: textfield; /* Firefox */
}

.bin-counter .btn {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
}

.remove-aisle-btn {
    color: #dc3545;
    border: 1px solid #dc3545;
    background: transparent;
}

.remove-aisle-btn:hover {
    background: #dc3545;
    color: white;
}

.remove-aisle-btn.disabled {
    color: #6c757d;
    border-color: #6c757d;
    background: #f8f9fa;
    cursor: not-allowed;
}

.remove-aisle-btn.disabled:hover {
    background: #f8f9fa;
    color: #6c757d;
}

.aisle-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

#noAislesMessage {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    background: #f8f9fa;
}

.occupied-location {
    background: #fff3cd;
    border-color: #ffeaa7;
}

.occupied-location .aisle-name {
    color: #856404;
}

.occupied-badge {
    background: #dc3545;
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 8px;
}
</style>
