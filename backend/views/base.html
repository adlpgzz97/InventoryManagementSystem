{% set error_messages = [] %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    {% if category == 'danger' or category == 'error' %}
      {% set _ = error_messages.append(message) %}
    {% endif %}
  {% endfor %}
{% endwith %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Inventory Management{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Smooth fade-out for center alert */
        .center-alert-fade {
            opacity: 0;
            transition: opacity 2s linear;
        }
        
        /* Compact header styling */
        .compact-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .compact-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .compact-header .btn-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Icon-only buttons */
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Sidebar styling */
        .sidebar {
            background-color: #f8f9fa;
            min-height: calc(100vh - 70px);
            border-right: 1px solid #dee2e6;
        }
        
        .nav-link.active {
            background-color: #0d6efd;
            color: white !important;
            border-radius: 0.375rem;
        }
        
        .nav-link {
            color: #495057;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
        }
        
        .nav-link:hover {
            background-color: #e9ecef;
            color: #495057;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .status-badge {
            font-size: 0.75rem;
        }
        
        /* Table enhancements */
        .sortable {
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .sortable:hover {
            background-color: #f8f9fa;
        }
        
        .table th.sortable {
            border-bottom: 2px solid #dee2e6;
        }
        
        .pagination .page-link {
            border-radius: 0.375rem;
            margin: 0 2px;
        }
        
        .table-enhanced {
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .table-responsive {
            border-radius: 0.5rem;
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body class="bg-light {% if current_user.is_authenticated %}logged-in{% endif %}">
    <!-- Compact Header -->
    <div class="container-fluid py-2 compact-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h1 class="mb-0 me-3">
                    <a href="/" class="text-decoration-none text-dark">
                        <i class="fas fa-boxes me-2"></i>Inventory Manager
                    </a> 
                    <span class="badge bg-secondary">v1.0</span>
                </h1>
                {% if current_user.is_authenticated %}
                    <span class="text-muted me-3">{{ current_user.username }} ({{ current_user.role }})</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if current_user.is_authenticated %}
                    {% if current_user.role == 'admin' %}
                        <a href="/admin/schema" class="btn btn-outline-success btn-sm me-2" title="Database Schema">
                            <i class="fas fa-database"></i>
                        </a>
                        <a href="/api/products" target="_blank" class="btn btn-outline-info btn-sm me-2" title="API Endpoints">
                            <i class="fas fa-code"></i>
                        </a>
                        <button class="btn btn-outline-warning btn-sm me-2" title="Database Status" id="db-status-btn">
                            <i class="fas fa-server"></i>
                        </button>
                    {% endif %}
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sign-in-alt me-1"></i>Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            {% if current_user.is_authenticated %}
            <!-- Sidebar -->
            <nav class="col-md-2 d-md-block sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
                                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'products' %}active{% endif %}" href="{{ url_for('products') }}">
                                <i class="fas fa-box me-2"></i> Products
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'stock' %}active{% endif %}" href="{{ url_for('stock') }}">
                                <i class="fas fa-boxes me-2"></i> Stock
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'warehouses' %}active{% endif %}" href="{{ url_for('warehouses') }}">
                                <i class="fas fa-warehouse me-2"></i> Warehouses
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'reports' %}active{% endif %}" href="{{ url_for('reports') }}">
                                <i class="fas fa-chart-bar me-2"></i> Reports
                            </a>
                        </li>
                        {% if current_user.role in ['admin', 'manager'] %}
                        <li class="nav-item mt-3">
                            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                                <span>Management</span>
                            </h6>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" title="Coming in Phase 2">
                                <i class="fas fa-shopping-cart me-2"></i> Orders <small class="text-muted">(Soon)</small>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" title="Coming in Phase 2">
                                <i class="fas fa-truck me-2"></i> Suppliers <small class="text-muted">(Soon)</small>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </nav>
            
            <!-- Main content -->
            <main class="col-md-10 ms-sm-auto main-content">
                {% endif %}
                
                <!-- Flash messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div id="center-alerts">
                            {% for category, message in messages %}
                                <div class="alert alert-{% if category == 'error' %}danger{% elif category == 'success' %}success{% elif category == 'info' %}info{% else %}warning{% endif %} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                
                <!-- Page content -->
                {% block content %}{% endblock %}
                
                {% if current_user.is_authenticated %}
            </main>
            {% endif %}
        </div>
    </div>

    <!-- Modal container for AJAX modals -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="editModalBody">
                    <!-- Edit form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Include Barcode Scanner Component -->
    {% include 'barcode_scanner.html' %}

    <!-- Debug Console for Admins -->
    {% if current_user.is_authenticated and current_user.role == 'admin' %}
    <div id="debug-console-container" style="position:fixed;bottom:0;left:0;width:100%;z-index:1050;">
        <div id="debug-console" style="background:#222;color:#eee;padding:10px 10px 30px 10px;max-height:200px;overflow-y:auto;display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span><strong>Debug Log</strong></span>
                <div>
                    <button id="copy-debug-log" class="btn btn-sm btn-secondary me-2" title="Copy log">Copy</button>
                    <button id="toggle-debug-console" class="btn btn-sm btn-secondary" title="Minimize">Minimize</button>
                </div>
            </div>
            <pre id="debug-log-text" style="margin:0;white-space:pre-wrap;"></pre>
        </div>
        <button id="show-debug-console" class="btn btn-sm btn-dark" style="position:absolute;right:10px;bottom:10px;display:block;">Show Debug Log</button>
    </div>
    {% endif %}
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Add error handling for desktop mode
    window.addEventListener('error', function(e) {
        console.error('JavaScript error:', e.error);
        if (window.webview) {
            window.webview.evaluate_js(`console.error('Desktop error: ${e.error}')`);
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Fade out any center alert on page load
        const alertDiv = document.getElementById('center-alerts');
        if (alertDiv) {
            setTimeout(() => {
                alertDiv.classList.add('center-alert-fade');
                setTimeout(() => { if (alertDiv) alertDiv.remove(); }, 2000);
            }, 3000);
        }

        // Debug console logic for admins
        const debugConsole = document.getElementById('debug-console');
        if (debugConsole) {
            const showBtn = document.getElementById('show-debug-console');
            const toggleBtn = document.getElementById('toggle-debug-console');
            const copyBtn = document.getElementById('copy-debug-log');
            const logText = document.getElementById('debug-log-text');
            
            showBtn.addEventListener('click', function() {
                debugConsole.style.display = 'block';
                showBtn.style.display = 'none';
            });
            
            toggleBtn.addEventListener('click', function() {
                debugConsole.style.display = 'none';
                showBtn.style.display = 'block';
            });
            
            copyBtn.addEventListener('click', function() {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(logText.textContent);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = logText.textContent;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
            });
            
            // Helper to log messages
            window.debugLog = function(msg) {
                logText.textContent += (msg + '\n');
                if (debugConsole.style.display === 'block') {
                    debugConsole.scrollTop = debugConsole.scrollHeight;
                }
            };
            
            // Log all flashed error messages to the debug log
            var flashedErrors = {{ error_messages|tojson|safe }};
            flashedErrors.forEach(function(msg) {
                window.debugLog('ERROR: ' + msg);
                if (flashedErrors.length > 0) {
                    debugConsole.style.display = 'block';
                    showBtn.style.display = 'none';
                }
            });
        }

        // Database status button
        const dbStatusBtn = document.getElementById('db-status-btn');
        if (dbStatusBtn) {
            dbStatusBtn.addEventListener('click', function() {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        const status = data.database ? 'Connected' : 'Disconnected';
                        const mode = data.mode || 'Unknown';
                        alert(`Database Status: ${status}\nMode: ${mode}\nTime: ${new Date().toLocaleString()}`);
                    })
                    .catch(error => {
                        alert('Error checking database status: ' + error.message);
                    });
            });
        }

        // Modal functionality
        const editModal = document.getElementById('editModal');
        const editModalBody = document.getElementById('editModalBody');
        const editModalLabel = document.getElementById('editModalLabel');

        // Edit button click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-btn') || e.target.closest('.edit-btn')) {
                e.preventDefault();
                const btn = e.target.classList.contains('edit-btn') ? e.target : e.target.closest('.edit-btn');
                const itemType = btn.getAttribute('data-type');
                const itemId = btn.getAttribute('data-id');
                
                if (itemType && itemId) {
                    loadEditModal(itemType, itemId);
                }
            }
        });

        // Add button click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-btn') || e.target.closest('.add-btn')) {
                e.preventDefault();
                const btn = e.target.classList.contains('add-btn') ? e.target : e.target.closest('.add-btn');
                const itemType = btn.getAttribute('data-type');
                
                if (itemType) {
                    loadAddModal(itemType);
                }
            }
        });

        // Delete button click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
                e.preventDefault();
                const btn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
                const itemType = btn.getAttribute('data-type');
                const itemId = btn.getAttribute('data-id');
                const itemName = btn.getAttribute('data-name') || 'this item';
                
                if (confirm(`Are you sure you want to delete ${itemName}? This action cannot be undone.`)) {
                    deleteItem(itemType, itemId);
                }
            }
        });

        // Load edit modal content
        function loadEditModal(itemType, itemId) {
            editModalLabel.textContent = `Edit ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}`;
            editModalBody.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            
            const modal = new bootstrap.Modal(editModal);
            modal.show();
            
            fetch(`/edit/${itemType}/${itemId}?modal=1`)
                .then(response => response.text())
                .then(html => {
                    editModalBody.innerHTML = html;
                    
                    // Handle form submission
                    const form = editModalBody.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitModalForm(form, modal);
                        });
                    }
                })
                .catch(error => {
                    editModalBody.innerHTML = `<div class="alert alert-danger">Error loading form: ${error.message}</div>`;
                });
        }

        // Load add modal content
        function loadAddModal(itemType) {
            editModalLabel.textContent = `Add New ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}`;
            editModalBody.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            
            const modal = new bootstrap.Modal(editModal);
            modal.show();
            
            fetch(`/add/${itemType}?modal=1`)
                .then(response => response.text())
                .then(html => {
                    editModalBody.innerHTML = html;
                    
                    // Handle form submission
                    const form = editModalBody.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitModalForm(form, modal);
                        });
                    }
                })
                .catch(error => {
                    editModalBody.innerHTML = `<div class="alert alert-danger">Error loading form: ${error.message}</div>`;
                });
        }

        // Submit modal form
        function submitModalForm(form, modal) {
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;
            
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                if (html.includes('alert-success') || html.includes('redirect')) {
                    modal.hide();
                    location.reload(); // Refresh page to show changes
                } else {
                    editModalBody.innerHTML = html;
                    // Re-attach form handler
                    const newForm = editModalBody.querySelector('form');
                    if (newForm) {
                        newForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitModalForm(newForm, modal);
                        });
                    }
                }
            })
            .catch(error => {
                editModalBody.innerHTML = `<div class="alert alert-danger">Error saving: ${error.message}</div>`;
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        // Delete item
        function deleteItem(itemType, itemId) {
            fetch(`/delete/${itemType}/${itemId}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    location.reload(); // Refresh page to show changes
                } else {
                    throw new Error('Delete failed');
                }
            })
            .catch(error => {
                alert('Error deleting item: ' + error.message);
            });
        }
    });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
