{% set error_messages = [] %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    {% if category == 'danger' or category == 'error' %}
      {% set _ = error_messages.append(message) %}
    {% endif %}
  {% endfor %}
{% endwith %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Inventory Management{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Smooth fade-out for center alert */
        .center-alert-fade {
            opacity: 0;
            transition: opacity 2s linear;
        }
        
        /* Compact header styling */
        .compact-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .compact-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .compact-header .btn-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Icon-only buttons */
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Sidebar styling */
        .sidebar {
            background-color: #f8f9fa;
            min-height: calc(100vh - 70px);
            border-right: 1px solid #dee2e6;
        }
        
        .nav-link.active {
            background-color: #0d6efd;
            color: white !important;
            border-radius: 0.375rem;
        }
        
        .nav-link {
            color: #495057;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
        }
        
        .nav-link:hover {
            background-color: #e9ecef;
            color: #495057;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .status-badge {
            font-size: 0.75rem;
        }
        
        /* Table enhancements */
        .sortable {
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .sortable:hover {
            background-color: #f8f9fa;
        }
        
        .table th.sortable {
            border-bottom: 2px solid #dee2e6;
        }
        
        .pagination .page-link {
            border-radius: 0.375rem;
            margin: 0 2px;
        }
        
        .table-enhanced {
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .table-responsive {
            border-radius: 0.5rem;
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body class="bg-light {% if current_user.is_authenticated %}logged-in{% endif %}">
    <!-- Compact Header -->
    <div class="container-fluid py-2 compact-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h1 class="mb-0 me-3">
                    <a href="/" class="text-decoration-none text-dark">
                        <i class="fas fa-boxes me-2"></i>Inventory Manager
                    </a> 
                    <span class="badge bg-secondary">v1.0</span>
                </h1>
                {% if current_user.is_authenticated %}
                    <span class="text-muted me-3">{{ current_user.username }} ({{ current_user.role }})</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if current_user.is_authenticated %}
                    {% if current_user.role == 'admin' %}
                        <a href="/admin/schema" class="btn btn-outline-success btn-sm me-2" title="Database Schema">
                            <i class="fas fa-database"></i>
                        </a>
                        <a href="/api/products" target="_blank" class="btn btn-outline-info btn-sm me-2" title="API Endpoints">
                            <i class="fas fa-code"></i>
                        </a>
                        <button class="btn btn-outline-warning btn-sm me-2" title="Database Status" id="db-status-btn">
                            <i class="fas fa-server"></i>
                        </button>
                    {% endif %}
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sign-in-alt me-1"></i>Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            {% if current_user.is_authenticated %}
            <!-- Sidebar -->
            <nav class="col-md-2 d-md-block sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
                                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'products' %}active{% endif %}" href="{{ url_for('products') }}">
                                <i class="fas fa-box me-2"></i> Products
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'stock' %}active{% endif %}" href="{{ url_for('stock') }}">
                                <i class="fas fa-boxes me-2"></i> Stock
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'warehouses' %}active{% endif %}" href="{{ url_for('warehouses') }}">
                                <i class="fas fa-warehouse me-2"></i> Warehouses
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'reports' %}active{% endif %}" href="{{ url_for('reports') }}">
                                <i class="fas fa-chart-bar me-2"></i> Reports
                            </a>
                        </li>
                        {% if current_user.role in ['admin', 'manager'] %}
                        <li class="nav-item mt-3">
                            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                                <span>Management</span>
                            </h6>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" title="Coming in Phase 2">
                                <i class="fas fa-shopping-cart me-2"></i> Orders <small class="text-muted">(Soon)</small>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" title="Coming in Phase 2">
                                <i class="fas fa-truck me-2"></i> Suppliers <small class="text-muted">(Soon)</small>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </nav>
            
            <!-- Main content -->
            <main class="col-md-10 ms-sm-auto main-content">
                {% endif %}
                
                <!-- Flash messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div id="center-alerts">
                            {% for category, message in messages %}
                                <div class="alert alert-{% if category == 'error' %}danger{% elif category == 'success' %}success{% elif category == 'info' %}info{% else %}warning{% endif %} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                
                <!-- Page content -->
                {% block content %}{% endblock %}
                
                {% if current_user.is_authenticated %}
            </main>
            {% endif %}
        </div>
    </div>

    <!-- Modal container for AJAX modals -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="editModalBody">
                    <!-- Edit form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Include Barcode Scanner Component -->
    {% include 'barcode_scanner.html' %}

    <!-- Debug Console for Admins -->
    {% if current_user.is_authenticated and current_user.role == 'admin' %}
    <div id="debug-console-container" style="position:fixed;bottom:0;left:0;width:100%;z-index:1050;">
        <div id="debug-console" style="background:#222;color:#eee;padding:10px 10px 30px 10px;max-height:200px;overflow-y:auto;display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span><strong>Debug Log</strong></span>
                <div>
                    <button id="copy-debug-log" class="btn btn-sm btn-secondary me-2" title="Copy log">Copy</button>
                    <button id="toggle-debug-console" class="btn btn-sm btn-secondary" title="Minimize">Minimize</button>
                </div>
            </div>
            <pre id="debug-log-text" style="margin:0;white-space:pre-wrap;"></pre>
        </div>
        <button id="show-debug-console" class="btn btn-sm btn-dark" style="position:absolute;right:10px;bottom:10px;display:block;">Show Debug Log</button>
    </div>
    {% endif %}
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Add error handling for desktop mode
    window.addEventListener('error', function(e) {
        console.error('JavaScript error:', e.error);
        if (window.webview) {
            window.webview.evaluate_js(`console.error('Desktop error: ${e.error}')`);
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Restore filter state if preserved
        restoreFilterState();
        
        // Fade out any center alert on page load
        const alertDiv = document.getElementById('center-alerts');
        if (alertDiv) {
            setTimeout(() => {
                alertDiv.classList.add('center-alert-fade');
                setTimeout(() => { if (alertDiv) alertDiv.remove(); }, 2000);
            }, 3000);
        }

        // Debug console logic for admins
        const debugConsole = document.getElementById('debug-console');
        if (debugConsole) {
            const showBtn = document.getElementById('show-debug-console');
            const toggleBtn = document.getElementById('toggle-debug-console');
            const copyBtn = document.getElementById('copy-debug-log');
            const logText = document.getElementById('debug-log-text');
            
            showBtn.addEventListener('click', function() {
                debugConsole.style.display = 'block';
                showBtn.style.display = 'none';
            });
            
            toggleBtn.addEventListener('click', function() {
                debugConsole.style.display = 'none';
                showBtn.style.display = 'block';
            });
            
            copyBtn.addEventListener('click', function() {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(logText.textContent);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = logText.textContent;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
            });
            
            // Helper to log messages
            window.debugLog = function(msg) {
                logText.textContent += (msg + '\n');
                if (debugConsole.style.display === 'block') {
                    debugConsole.scrollTop = debugConsole.scrollHeight;
                }
            };
            
            // Log all flashed error messages to the debug log
            var flashedErrors = {{ error_messages|tojson|safe }};
            flashedErrors.forEach(function(msg) {
                window.debugLog('ERROR: ' + msg);
                if (flashedErrors.length > 0) {
                    debugConsole.style.display = 'block';
                    showBtn.style.display = 'none';
                }
            });
        }

        // Database status button
        const dbStatusBtn = document.getElementById('db-status-btn');
        if (dbStatusBtn) {
            dbStatusBtn.addEventListener('click', function() {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        const status = data.database ? 'Connected' : 'Disconnected';
                        const mode = data.mode || 'Unknown';
                        alert(`Database Status: ${status}\nMode: ${mode}\nTime: ${new Date().toLocaleString()}`);
                    })
                    .catch(error => {
                        alert('Error checking database status: ' + error.message);
                    });
            });
        }

        // Modal functionality
        const editModal = document.getElementById('editModal');
        const editModalBody = document.getElementById('editModalBody');
        const editModalLabel = document.getElementById('editModalLabel');

        // Edit button click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-btn') || e.target.closest('.edit-btn')) {
                e.preventDefault();
                const btn = e.target.classList.contains('edit-btn') ? e.target : e.target.closest('.edit-btn');
                const itemType = btn.getAttribute('data-type');
                const itemId = btn.getAttribute('data-id');
                
                if (itemType && itemId) {
                    loadEditModal(itemType, itemId);
                }
            }
        });

        // Add button click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-btn') || e.target.closest('.add-btn')) {
                e.preventDefault();
                const btn = e.target.classList.contains('add-btn') ? e.target : e.target.closest('.add-btn');
                const itemType = btn.getAttribute('data-type');
                
                if (itemType) {
                    loadAddModal(itemType);
                }
            }
        });

        // Delete button click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
                e.preventDefault();
                const btn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
                const itemType = btn.getAttribute('data-type');
                const itemId = btn.getAttribute('data-id');
                const itemName = btn.getAttribute('data-name') || 'this item';
                
                if (confirm(`Are you sure you want to delete ${itemName}? This action cannot be undone.`)) {
                    deleteItem(itemType, itemId);
                }
            }
        });

        // Load edit modal content
        function loadEditModal(itemType, itemId) {
            editModalLabel.textContent = `Edit ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}`;
            editModalBody.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            
            const modal = new bootstrap.Modal(editModal);
            modal.show();
            
            fetch(`/edit/${itemType}/${itemId}?modal=1`)
                .then(response => response.text())
                .then(html => {
                    editModalBody.innerHTML = html;
                    
                    // Handle form submission
                    const form = editModalBody.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitModalForm(form, modal);
                        });
                    }
                    
                    // Initialize warehouse-specific functionality if it's a warehouse modal
                    if (itemType === 'warehouse') {
                        initializeWarehouseModal(true); // true indicates edit mode
                    }
                })
                .catch(error => {
                    editModalBody.innerHTML = `<div class="alert alert-danger">Error loading form: ${error.message}</div>`;
                });
        }

        // Load add modal content
        function loadAddModal(itemType) {
            editModalLabel.textContent = `Add New ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}`;
            editModalBody.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            
            const modal = new bootstrap.Modal(editModal);
            modal.show();
            
            fetch(`/add/${itemType}?modal=1`)
                .then(response => response.text())
                .then(html => {
                    editModalBody.innerHTML = html;
                    
                    // Handle form submission
                    const form = editModalBody.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitModalForm(form, modal);
                        });
                    }
                    
                    // Initialize warehouse-specific functionality if it's a warehouse modal
                    if (itemType === 'warehouse') {
                        initializeWarehouseModal();
                    }
                })
                .catch(error => {
                    editModalBody.innerHTML = `<div class="alert alert-danger">Error loading form: ${error.message}</div>`;
                });
        }

        // Submit modal form
        function submitModalForm(form, modal) {
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;
            
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                if (html.includes('alert-success') || html.includes('redirect')) {
                    modal.hide();
                    location.reload(); // Refresh page to show changes
                } else {
                    editModalBody.innerHTML = html;
                    // Re-attach form handler
                    const newForm = editModalBody.querySelector('form');
                    if (newForm) {
                        newForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitModalForm(newForm, modal);
                        });
                    }
                }
            })
            .catch(error => {
                editModalBody.innerHTML = `<div class="alert alert-danger">Error saving: ${error.message}</div>`;
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        // Delete item
        function deleteItem(itemType, itemId) {
            fetch(`/delete/${itemType}/${itemId}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    // Preserve filter state and reload
                    preserveAndReload();
                } else {
                    throw new Error('Delete failed');
                }
            })
            .catch(error => {
                alert('Error deleting item: ' + error.message);
            });
        }

        // Preserve filter state and reload page
        function preserveAndReload() {
            // Store current filter state in sessionStorage
            const currentUrl = window.location.href;
            
            console.log('Preserving URL for reload:', currentUrl);
            
            // Store the current URL to restore filters after reload
            sessionStorage.setItem('preserveFilters', currentUrl);
            
            // Reload the page
            location.reload();
        }

        // Restore filter state after page reload
        function restoreFilterState() {
            console.log('restoreFilterState called');
            const preservedUrl = sessionStorage.getItem('preserveFilters');
            console.log('Preserved URL from sessionStorage:', preservedUrl);
            
            if (preservedUrl) {
                // Clear the stored URL
                sessionStorage.removeItem('preserveFilters');
                
                // Check if we're on the same page
                const currentPath = window.location.pathname;
                const preservedPath = new URL(preservedUrl).pathname;
                
                console.log('Current path:', currentPath, 'Preserved path:', preservedPath);
                
                if (currentPath === preservedPath) {
                    // We're on the same page, restore the URL state
                    window.history.replaceState({}, '', preservedUrl);
                    console.log('Restored URL state to:', preservedUrl);
                    
                    // Trigger filter restoration based on current page
                    if (currentPath === '/stock') {
                        restoreStockFilters();
                    } else if (currentPath === '/products') {
                        restoreProductFilters();
                    } else if (currentPath === '/warehouses') {
                        restoreWarehouseFilters();
                    }
                }
            } else {
                // If no preserved URL, check if there are URL parameters to restore
                const url = new URL(window.location);
                const hasParams = url.searchParams.toString().length > 0;
                
                console.log('No preserved URL, checking for URL params:', hasParams);
                
                if (hasParams) {
                    const currentPath = window.location.pathname;
                    if (currentPath === '/stock') {
                        restoreStockFilters();
                    } else if (currentPath === '/products') {
                        restoreProductFilters();
                    } else if (currentPath === '/warehouses') {
                        restoreWarehouseFilters();
                    }
                }
            }
        }

        // Restore stock filters
        function restoreStockFilters() {
            console.log('Restoring stock filters...');
            const url = new URL(window.location.href);
            const searchTerm = url.searchParams.get('search');
            const warehouse = url.searchParams.get('warehouse');
            const status = url.searchParams.get('status');
            const lowStock = url.searchParams.get('lowStock');
            
            console.log('URL params:', { searchTerm, warehouse, status, lowStock });
            
            if (searchTerm) {
                const searchInput = document.getElementById('search-stock');
                if (searchInput) {
                    searchInput.value = searchTerm;
                    console.log('Set search input to:', searchTerm);
                }
            }
            
            if (warehouse) {
                const warehouseSelect = document.getElementById('filter-warehouse');
                if (warehouseSelect) {
                    warehouseSelect.value = warehouse;
                    console.log('Set warehouse filter to:', warehouse);
                }
            }
            
            if (status) {
                const statusSelect = document.getElementById('filter-status');
                if (statusSelect) {
                    statusSelect.value = status;
                    console.log('Set status filter to:', status);
                }
            }
            
            if (lowStock === 'true') {
                const lowStockCheckbox = document.getElementById('showLowStock');
                if (lowStockCheckbox) {
                    lowStockCheckbox.checked = true;
                    console.log('Set low stock checkbox to true');
                }
            }
            
            // Re-apply filters
            if (typeof filterStock === 'function') {
                console.log('Calling filterStock function...');
                filterStock();
            } else {
                console.log('filterStock function not found');
            }
        }

        // Restore product filters
        function restoreProductFilters() {
            const url = new URL(window.location.href);
            const searchTerm = url.searchParams.get('search');
            const category = url.searchParams.get('category');
            const status = url.searchParams.get('status');
            
            if (searchTerm) {
                const searchInput = document.getElementById('search-products');
                if (searchInput) {
                    searchInput.value = searchTerm;
                }
            }
            
            if (category) {
                const categorySelect = document.getElementById('filter-category');
                if (categorySelect) {
                    categorySelect.value = category;
                }
            }
            
            if (status) {
                const statusSelect = document.getElementById('filter-status');
                if (statusSelect) {
                    statusSelect.value = status;
                }
            }
            
            // Re-apply filters
            if (typeof filterProducts === 'function') {
                filterProducts();
            }
        }

        // Restore warehouse filters
        function restoreWarehouseFilters() {
            const url = new URL(window.location.href);
            const searchTerm = url.searchParams.get('search');
            
            if (searchTerm) {
                const searchInput = document.getElementById('search-warehouses');
                if (searchInput) {
                    searchInput.value = searchTerm;
                }
            }
            
            // Re-apply filters
            if (typeof filterWarehouses === 'function') {
                filterWarehouses();
            }
        }

        // Initialize warehouse modal functionality
        function initializeWarehouseModal(isEditMode = false) {
            let aisles = [];
            let nextAisleLetter = 'A';
            let occupiedLocations = new Set();
            
            // If in edit mode, load existing locations
            if (isEditMode) {
                console.log('Edit mode detected, looking for existing locations...');
                const existingLocationsInput = document.getElementById('existingLocations');
                console.log('Existing locations input found:', existingLocationsInput);
                if (existingLocationsInput && existingLocationsInput.value && existingLocationsInput.value.trim() !== '') {
                    console.log('Existing locations value:', existingLocationsInput.value);
                    console.log('Existing locations value length:', existingLocationsInput.value.length);
                    try {
                        const existingLocations = JSON.parse(existingLocationsInput.value);
                        console.log('Parsed existing locations:', existingLocations);
                        
                        // Group locations by aisle
                        const aisleGroups = {};
                        existingLocations.forEach(location => {
                            const aisle = location.aisle;
                            if (!aisleGroups[aisle]) {
                                aisleGroups[aisle] = [];
                            }
                            aisleGroups[aisle].push(location);
                        });
                        
                                                 // Convert to aisles array
                         Object.keys(aisleGroups).sort().forEach(aisle => {
                             const locations = aisleGroups[aisle];
                             const bins = Math.max(...locations.map(loc => parseInt(loc.bin)));
                             
                                                           const aisleObj = {
                                  id: `aisle_${Date.now()}_${Math.floor(Math.random() * 1000)}`,
                                  name: aisle,
                                  bins: bins,
                                  existing: true,
                                  locationIds: locations.map(loc => loc.id)
                              };
                             aisles.push(aisleObj);
                             console.log('Created aisle:', aisleObj);
                         });
                         
                         // Ensure the aisles array is properly initialized before displaying
                         console.log('Final aisles array:', aisles);
                        
                        // Set next aisle letter
                        if (aisles.length > 0) {
                            const lastAisle = aisles[aisles.length - 1].name;
                            nextAisleLetter = String.fromCharCode(lastAisle.charCodeAt(0) + 1);
                        }
                        
                        // Display aisles immediately after parsing
                        updateAislesDisplay();
                        
                        // Get occupied locations for validation (in background)
                        fetch(`/api/warehouse/${document.querySelector('form').action.split('/').pop().split('?')[0]}/occupied-locations`)
                            .then(response => response.json())
                            .then(data => {
                                occupiedLocations = new Set(data.occupied_locations || []);
                                updateAislesDisplay(); // Update again with occupied info
                            })
                            .catch(error => {
                                console.error('Error fetching occupied locations:', error);
                                // Don't call updateAislesDisplay() here since it's already been called
                            });
                    } catch (error) {
                        console.error('Error parsing existing locations:', error);
                        updateAislesDisplay();
                    }
                } else {
                    updateAislesDisplay();
                }
            } else {
                // Initialize the interface for add mode
                updateAislesDisplay();
            }
            
                         // Quick Setup functionality (only for add mode)
             if (!isEditMode) {
                 const applyQuickSetupBtn = document.getElementById('applyQuickSetup');
                 if (applyQuickSetupBtn) {
                     applyQuickSetupBtn.addEventListener('click', function() {
                         const numAisles = parseInt(document.getElementById('quick_aisles').value) || 3;
                         const defaultBins = parseInt(document.getElementById('quick_bins').value) || 5;
                         
                         if (numAisles < 1 || numAisles > 26) {
                             alert('Please enter a valid number of aisles (1-26)');
                             return;
                         }
                         
                         if (defaultBins < 1 || defaultBins > 50) {
                             alert('Please enter a valid number of bins (1-50)');
                             return;
                         }
                         
                         // Clear existing aisles
                         aisles = [];
                         nextAisleLetter = 'A';
                         
                         // Create new aisles
                         for (let i = 0; i < numAisles; i++) {
                             const aisleLetter = String.fromCharCode(65 + i); // A, B, C, etc.
                                                  aisles.push({
                         id: `aisle_${Date.now()}_${i}`,
                         name: aisleLetter,
                         bins: defaultBins
                     });
                         }
                         
                         nextAisleLetter = String.fromCharCode(65 + numAisles);
                         updateAislesDisplay();
                     });
                 }
             }
            
            // Add Aisle functionality
            const addAisleBtn = document.getElementById('addAisleBtn');
            if (addAisleBtn) {
                addAisleBtn.addEventListener('click', function() {
                    if (nextAisleLetter > 'Z') {
                        alert('Maximum 26 aisles allowed (A-Z)');
                        return;
                    }
                    
                                         aisles.push({
                         id: `aisle_${Date.now()}_new`,
                         name: nextAisleLetter,
                         bins: 5
                     });
                    
                    nextAisleLetter = String.fromCharCode(nextAisleLetter.charCodeAt(0) + 1);
                    updateAislesDisplay();
                });
            }
            
                         function updateAislesDisplay() {
                 console.log('updateAislesDisplay called with aisles:', aisles);
                 const aislesList = document.getElementById('aislesList');
                 const noAislesMessage = document.getElementById('noAislesMessage');
                 
                 if (aisles.length === 0) {
                     aislesList.innerHTML = '';
                     noAislesMessage.style.display = 'block';
                 } else {
                     noAislesMessage.style.display = 'none';
                     aislesList.innerHTML = aisles.map(aisle => createAisleRow(aisle)).join('');
                 }
                 
                 // Update hidden input for form submission
                 const aislesDataInput = document.getElementById('aislesData');
                 if (aislesDataInput) {
                     aislesDataInput.value = JSON.stringify(aisles);
                 }
                 
                 // Reattach event listeners
                 attachAisleEventListeners();
             }
            
            function createAisleRow(aisle) {
                // Check if this aisle has occupied locations
                const hasOccupiedLocations = aisle.existing && aisle.locationIds && 
                    Array.from(occupiedLocations).some(occupied => 
                        aisle.locationIds.includes(parseInt(occupied))
                    );
                
                const rowClass = hasOccupiedLocations ? 'aisle-row occupied-location' : 'aisle-row';
                const removeBtnClass = hasOccupiedLocations ? 'btn btn-sm remove-aisle-btn disabled' : 'btn btn-sm remove-aisle-btn';
                const removeBtnDisabled = hasOccupiedLocations ? 'disabled' : '';
                const occupiedBadge = hasOccupiedLocations ? '<span class="occupied-badge">Occupied</span>' : '';
                
                return `
                    <div class="${rowClass}" data-aisle-id="${aisle.id}">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <span class="aisle-name">Aisle ${aisle.name}</span>
                                ${occupiedBadge}
                            </div>
                            <div class="col-md-6">
                                <div class="bin-counter">
                                    <button type="button" class="btn btn-outline-secondary btn-sm bin-minus" 
                                            data-aisle-id="${aisle.id}">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="form-control bin-count" 
                                           value="${aisle.bins}" min="1" max="50" 
                                           data-aisle-id="${aisle.id}">
                                    <button type="button" class="btn btn-outline-secondary btn-sm bin-plus" 
                                            data-aisle-id="${aisle.id}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <span class="text-muted ms-2">bins</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="aisle-actions">
                                    <button type="button" class="${removeBtnClass}" 
                                            data-aisle-id="${aisle.id}" ${removeBtnDisabled}>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
                         function attachAisleEventListeners() {
                                   // Bin count input change
                  document.querySelectorAll('.bin-count').forEach(input => {
                      input.addEventListener('change', function() {
                          const aisleId = this.dataset.aisleId;
                          const newValue = parseInt(this.value) || 1;
                          const aisle = aisles.find(a => a.id === aisleId);
                          if (aisle) {
                              aisle.bins = Math.max(1, Math.min(50, newValue));
                              this.value = aisle.bins;
                              updateAislesDisplay();
                          }
                      });
                  });
                  
                  // Plus button
                  document.querySelectorAll('.bin-plus').forEach(btn => {
                      btn.addEventListener('click', function() {
                          console.log('Plus button clicked for aisle ID:', this.dataset.aisleId);
                          const aisleId = this.dataset.aisleId;
                          const aisle = aisles.find(a => a.id === aisleId);
                          console.log('Found aisle:', aisle);
                          if (aisle && aisle.bins < 50) {
                              aisle.bins++;
                              console.log('Updated aisle bins to:', aisle.bins);
                              updateAislesDisplay();
                          }
                      });
                  });
                  
                  // Minus button
                  document.querySelectorAll('.bin-minus').forEach(btn => {
                      btn.addEventListener('click', function() {
                          console.log('Minus button clicked for aisle ID:', this.dataset.aisleId);
                          const aisleId = this.dataset.aisleId;
                          const aisle = aisles.find(a => a.id === aisleId);
                          console.log('Found aisle:', aisle);
                          if (aisle && aisle.bins > 1) {
                              aisle.bins--;
                              console.log('Updated aisle bins to:', aisle.bins);
                              updateAislesDisplay();
                          }
                      });
                  });
                
                // Remove aisle button
                document.querySelectorAll('.remove-aisle-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (this.disabled) {
                            return; // Don't allow removal of occupied aisles
                        }
                        
                                                 const aisleId = this.dataset.aisleId;
                         const aisleIndex = aisles.findIndex(a => a.id === aisleId);
                        if (aisleIndex !== -1) {
                            const removedAisle = aisles[aisleIndex];
                            
                            // Check if this aisle has occupied locations (for edit mode)
                            if (isEditMode && removedAisle.existing && removedAisle.locationIds) {
                                const hasOccupiedLocations = Array.from(occupiedLocations).some(occupied => 
                                    removedAisle.locationIds.includes(parseInt(occupied))
                                );
                                
                                if (hasOccupiedLocations) {
                                    alert(`Cannot remove Aisle ${removedAisle.name} because it contains occupied locations. Please move or remove the stock items first.`);
                                    return;
                                }
                            }
                            
                            aisles.splice(aisleIndex, 1);
                            
                            // Update next aisle letter if we removed the last one
                            if (removedAisle.name >= nextAisleLetter) {
                                nextAisleLetter = removedAisle.name;
                            }
                            
                            updateAislesDisplay();
                        }
                    });
                });
            }
            
            // Form submission validation
            const form = document.getElementById('addWarehouseForm') || document.getElementById('editWarehouseForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    if (aisles.length === 0) {
                        e.preventDefault();
                        alert('Please add at least one aisle before creating the warehouse.');
                        return;
                    }
                    
                    // Validate warehouse name
                    const warehouseName = document.getElementById('name').value.trim();
                    if (!warehouseName) {
                        e.preventDefault();
                        alert('Please enter a warehouse name.');
                        return;
                    }
                    
                    // For edit mode, check if any occupied locations are being removed
                    if (isEditMode) {
                        const existingLocationsInput = document.getElementById('existingLocations');
                        if (existingLocationsInput && existingLocationsInput.value) {
                            try {
                                const existingLocations = JSON.parse(existingLocationsInput.value);
                                const existingLocationIds = new Set(existingLocations.map(loc => loc.id));
                                
                                // Get all location IDs from current aisles
                                const currentLocationIds = new Set();
                                aisles.forEach(aisle => {
                                    if (aisle.existing && aisle.locationIds) {
                                        aisle.locationIds.forEach(id => currentLocationIds.add(id));
                                    }
                                });
                                
                                // Find removed location IDs
                                const removedLocationIds = Array.from(existingLocationIds).filter(id => !currentLocationIds.has(id));
                                
                                // Check if any removed locations are occupied
                                const occupiedRemovedLocations = removedLocationIds.filter(id => 
                                    Array.from(occupiedLocations).includes(id.toString())
                                );
                                
                                if (occupiedRemovedLocations.length > 0) {
                                    e.preventDefault();
                                    alert('Cannot remove occupied locations. Please move or remove the stock items first.');
                                    return;
                                }
                            } catch (error) {
                                console.error('Error validating occupied locations:', error);
                            }
                        }
                    }
                });
            }
        }
    });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
