<!-- Bin Details Modal -->
<div class="modal fade" id="binDetailsModal" tabindex="-1" aria-labelledby="binDetailsLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="binDetailsLabel">
                    <i class="fas fa-box me-2"></i>Bin Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Bin Information -->
                <div id="binInfo" class="location-info mb-4" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-box me-2"></i>Bin Details</h5>
                            <div id="binDetails"></div>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-warehouse me-2"></i>Location Info</h5>
                            <div id="locationDetails"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Stock Items -->
                <div id="stockItemsContainer" class="stock-items-container" style="display: none;">
                    <h5><i class="fas fa-boxes me-2"></i>Products in Bin</h5>
                    <div id="stockItemsList"></div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <h4>Loading Bin Details...</h4>
                    <p>Please wait while we fetch the bin information</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Modal -->
<div class="modal fade transaction-modal" id="transactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>
                    <span id="transactionTitle">Perform Action</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="transactionForm">
                    <!-- Form will be dynamically populated -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitTransaction">
                    <i class="fas fa-check me-1"></i>Submit Transaction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Stock Modal -->
<div class="modal fade" id="assignStockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Assign Stock to Bin
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Bin Code</label>
                            <input type="text" class="form-control" id="assignBinCode" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="assignLocationCode" readonly>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Product *</label>
                            <select class="form-select" id="assignProductId" required>
                                <option value="">Select a product...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="assignQuantity" min="1" value="1" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Batch ID</label>
                            <input type="text" class="form-control" id="assignBatchId" placeholder="Optional batch identifier">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Expiry Date</label>
                            <input type="date" class="form-control" id="assignExpiryDate">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="assignNotes" rows="3" 
                              placeholder="Enter any additional notes for this assignment"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submitAssignStock">
                    <i class="fas fa-check me-1"></i>Assign Stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Change Location Modal -->
<div class="modal fade" id="changeLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    Change Bin Location
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Bin Code</label>
                            <input type="text" class="form-control" id="changeLocationBinCode" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Current Location</label>
                            <input type="text" class="form-control" id="changeLocationCurrentLocation" readonly>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">New Location *</label>
                    <div class="position-relative">
                        <input type="text" 
                               class="form-control" 
                               id="changeLocationInput" 
                               placeholder="Type location code or scan barcode..."
                               autocomplete="off"
                               required>
                        <div id="locationAutocomplete" class="autocomplete-dropdown" style="display: none;"></div>
                    </div>
                    <input type="hidden" id="changeLocationNewLocation" value="">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Type to search locations or scan a location barcode
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="changeLocationNotes" rows="3" 
                              placeholder="Enter any additional notes for this location change"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="submitChangeLocation">
                    <i class="fas fa-check me-1"></i>Change Location
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Move Stock Modal -->
<div class="modal fade" id="moveStockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-arrows-alt me-2"></i>
                    Move Stock Between Bins
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Current Bin (Left Side) -->
                    <div class="col-md-5">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-box me-2"></i>From (Current Bin)</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Bin Code</label>
                                    <input type="text" class="form-control" id="moveCurrentBinCode" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-control" id="moveCurrentLocation" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Warehouse</label>
                                    <input type="text" class="form-control" id="moveCurrentWarehouse" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Product</label>
                                    <input type="text" class="form-control" id="moveProductName" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Quantity On-Hand</label>
                                    <input type="text" class="form-control" id="moveAvailableQuantity" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Arrow -->
                    <div class="col-md-2 d-flex align-items-center justify-content-center">
                        <div class="text-center">
                            <i class="fas fa-arrow-right fa-2x text-primary"></i>
                            <div class="mt-2">
                                <label class="form-label">Quantity to Move</label>
                                <div class="input-group mb-2">
                                    <input type="number" class="form-control" id="moveQuantity" min="0" value="0">
                                    <button class="btn btn-outline-secondary" type="button" id="moveAllStock">All Stock</button>
                                </div>
                                <label class="form-label">Reserved to Move</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="moveReservedQuantity" min="0" value="0">
                                    <button class="btn btn-outline-secondary" type="button" id="moveAllReserved">All Reserved</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Destination Bin (Right Side) -->
                    <div class="col-md-5">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>To (Destination Bin)</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Destination Bin *</label>
                                    <select id="moveDestinationBinSelect" class="form-select" required>
                                        <option value="">Select Destination Bin</option>
                                    </select>
                                    <input type="hidden" id="moveDestinationBinId" value="">
                                    <div class="form-check form-switch mt-2" id="moveShowSameProductContainer" style="display:none;">
                                        <input class="form-check-input" type="checkbox" id="moveShowSameProduct">
                                        <label class="form-check-label" for="moveShowSameProduct">Show bins with this product</label>
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Select an eligible bin (requires location; hides bins occupied by other products). Toggle to choose empty bins vs. bins with this product.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Destination Location</label>
                                    <input type="text" class="form-control" id="moveDestinationLocation" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Destination Warehouse</label>
                                    <input type="text" class="form-control" id="moveDestinationWarehouse" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-control" id="moveNotes" rows="3" 
                                              placeholder="Enter any additional notes for this move"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitMoveStock">
                    <i class="fas fa-check me-1"></i>Move Stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <i class="fas fa-check-circle text-success" style="font-size: 48px;"></i>
                <h5 class="mt-3">Operation Successful!</h5>
                <p id="successMessage" class="text-muted"></p>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">Continue</button>
            </div>
        </div>
    </div>
</div>

<style>
.location-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 5px solid #4CAF50;
}

.stock-items-container {
    max-height: 400px;
    overflow-y: auto;
}

.stock-item-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.stock-item-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.action-btn {
    flex: 1;
    min-width: 120px;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.action-btn:hover {
    /* Removed floating effect */
}

.btn-pick { background: #2196F3; color: white; }
.btn-pick:hover { background: #1976D2; }

.btn-restock { background: #4CAF50; color: white; }
.btn-restock:hover { background: #388E3C; }

.btn-move { background: #FF9800; color: white; }
.btn-move:hover { background: #F57C00; }

.btn-adjust { background: #9C27B0; color: white; }
.btn-adjust:hover { background: #7B1FA2; }

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-available { background: #4CAF50; }
.status-low { background: #FF9800; }
.status-out { background: #F44336; }

.transaction-modal .modal-content {
    border-radius: 15px;
}

.transaction-modal .modal-header {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border-radius: 15px 15px 0 0;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #ccc;
}

.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1050;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.autocomplete-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.autocomplete-item:hover {
    background-color: #f8f9fa;
}

.autocomplete-item.selected {
    background-color: #e3f2fd;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item .location-code {
    font-weight: bold;
    color: #2196F3;
}

.autocomplete-item .warehouse-name {
    font-size: 0.9em;
    color: #666;
}
</style>

<script>
class BinDetailsManager {
    constructor() {
        this.currentBin = null;
        this.availableLocations = [];
        this.availableBins = [];
        this.initializeEventListeners();
    }
    
    initializeEventListeners() {
        // Handle transaction submission
        const submitTxn = document.getElementById('submitTransaction');
        if (submitTxn) submitTxn.addEventListener('click', () => this.submitTransaction());
        
        // Handle assign stock submission
        const submitAssign = document.getElementById('submitAssignStock');
        if (submitAssign) submitAssign.addEventListener('click', () => this.submitAssignStock());
        
        // Handle change location submission
        const submitChangeLoc = document.getElementById('submitChangeLocation');
        if (submitChangeLoc) submitChangeLoc.addEventListener('click', () => this.submitChangeLocation());
        
        // Handle move stock submission
        const submitMove = document.getElementById('submitMoveStock');
        if (submitMove) submitMove.addEventListener('click', () => this.submitMoveStock());
        
        // Handle "All Stock" button
        const moveAll = document.getElementById('moveAllStock');
        if (moveAll) moveAll.addEventListener('click', () => this.setMoveAllStock());
        // Handle "All Reserved" button
        const moveAllReserved = document.getElementById('moveAllReserved');
        if (moveAllReserved) moveAllReserved.addEventListener('click', () => this.setMoveAllReserved());
        
        // Handle location search input
        const changeLocInput = document.getElementById('changeLocationInput');
        if (changeLocInput) {
            changeLocInput.addEventListener('input', (e) => this.searchLocations(e.target.value));
            changeLocInput.addEventListener('focus', (e) => {
                if (e.target.value.length > 0) this.searchLocations(e.target.value);
            });
        }
        
        // Handle clicks outside autocomplete dropdown
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#changeLocationInput') && !e.target.closest('#locationAutocomplete')) {
                document.getElementById('locationAutocomplete').style.display = 'none';
            }
        });
        
        // Handle modal cleanup when modals are closed
        const changeLocModalEl = document.getElementById('changeLocationModal');
        if (changeLocModalEl) changeLocModalEl.addEventListener('hidden.bs.modal', () => this.cleanupModalBackdrop());
        
        const successModalEl = document.getElementById('successModal');
        if (successModalEl) successModalEl.addEventListener('hidden.bs.modal', () => this.cleanupModalBackdrop());
        
        // Handle action button clicks using event delegation
        document.addEventListener('click', (e) => {
            if (e.target.closest('.action-btn')) {
                const button = e.target.closest('.action-btn');
                const action = button.dataset.action;
                const stockId = button.dataset.stockId;
                const productName = button.dataset.productName;
                
                if (action && stockId && productName) {
                    this.showTransactionModal(action, stockId, productName);
                }
            }
        });
    }
    
    async showBinDetails(binCode) {
        const modal = new bootstrap.Modal(document.getElementById('binDetailsModal'));
        
        // Show loading state
        this.showLoading();
        
        try {
            const response = await fetch(`/warehouses/api/bin/${binCode}`, {
                credentials: 'same-origin'
            });
            const data = await response.json();
            
            if (response.ok) {
                this.displayBinData(data);
                modal.show();
            } else {
                this.showError(data.error || 'Bin not found');
                modal.show();
            }
        } catch (error) {
            console.error('Error fetching bin data:', error);
            this.showError('Network error occurred');
            modal.show();
        }
    }
    
    displayBinData(data) {
        this.currentBin = data.bin;
        this.currentBin.stock_items = data.stock_items;
        
        // Show bin info
        document.getElementById('binInfo').style.display = 'block';
        
        document.getElementById('binDetails').innerHTML = `
            <p class="mb-1"><strong>Bin Code:</strong> <span id="binCodeText">${data.bin.code}</span></p>
            <div class="input-group input-group-sm mb-2" style="max-width: 240px;">
                <span class="input-group-text">New Code</span>
                <input type="text" class="form-control" id="renameBinInput" placeholder="B1234" maxlength="5">
                <button class="btn btn-outline-primary" id="renameBinBtn" title="Rename bin">
                    <i class="fas fa-pen"></i>
                </button>
            </div>
            <p><strong>Location:</strong> ${data.bin.location_code || 'Not assigned'}</p>
            <button class="btn btn-warning btn-sm mt-2" onclick="binDetailsManager.showChangeLocationModal()">
                <i class="fas fa-map-marker-alt me-1"></i>Change Location
            </button>
            <button class="btn btn-outline-danger btn-sm mt-2 ms-2" id="deleteBinBtn" title="Delete bin">
                <i class="fas fa-trash"></i> Delete Bin
            </button>
        `;
        
        document.getElementById('locationDetails').innerHTML = `
            <p><strong>Warehouse:</strong> ${data.bin.warehouse_name || 'Not assigned'}</p>
            <p><strong>Warehouse Code:</strong> ${data.bin.warehouse_code || 'Not assigned'}</p>
            <p><strong>Address:</strong> ${data.bin.warehouse_address || 'Not assigned'}</p>
        `;
        
        // Check if bin has stock items
        if (data.bin.has_stock) {
            this.displayStockItems(data.stock_items);
            document.getElementById('stockItemsContainer').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            // Disable delete when has stock
            const delBtn = document.getElementById('deleteBinBtn');
            if (delBtn) { delBtn.disabled = true; delBtn.title = 'Cannot delete a bin that has stock'; }
        } else {
            this.showEmptyBin();
            const delBtn = document.getElementById('deleteBinBtn');
            if (delBtn) { delBtn.disabled = false; delBtn.title = 'Delete this empty bin'; }
        }

        // Wire rename/delete actions
        const renameBtn = document.getElementById('renameBinBtn');
        if (renameBtn) {
            renameBtn.onclick = () => this.submitRenameBin();
        }
        const deleteBtn = document.getElementById('deleteBinBtn');
        if (deleteBtn) {
            deleteBtn.onclick = () => this.submitDeleteBin();
        }
    }
    
    displayStockItems(stockItems) {
        const container = document.getElementById('stockItemsList');
        container.innerHTML = '';
        
        stockItems.forEach(item => {
            const card = document.createElement('div');
            card.className = 'stock-item-card';
            
            const availableVal = Math.max(0, Number(item.on_hand || 0) - Number(item.qty_reserved || 0));
            const statusClass = this.getStatusClass(availableVal);
            
            card.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h6 class="mb-1">${item.product_name}</h6>
                        <small class="text-muted">SKU: ${item.sku}</small>
                        ${item.barcode ? `<br><small class="text-muted">Barcode: ${item.barcode}</small>` : ''}
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator ${statusClass}"></span>
                            <div>
                                <div><strong>Available:</strong> ${availableVal}</div>
                                <div><strong>Reserved:</strong> ${item.qty_reserved}</div>
                                <div><strong>Total:</strong> ${item.total_qty}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="action-buttons">
                            <button class="action-btn btn-pick" data-action="pick" data-stock-id="${item.id}" data-product-name="${item.product_name}">
                                <i class="fas fa-hand-paper me-1"></i>Pick
                            </button>
                            <button class="action-btn btn-restock" data-action="receive" data-stock-id="${item.id}" data-product-name="${item.product_name}">
                                <i class="fas fa-plus me-1"></i>Restock
                            </button>
                            <button class="action-btn btn-adjust" data-action="adjust" data-stock-id="${item.id}" data-product-name="${item.product_name}">
                                <i class="fas fa-edit me-1"></i>Adjust
                            </button>
                            <button class="action-btn btn-move" data-action="transfer" data-stock-id="${item.id}" data-product-name="${item.product_name}">
                                <i class="fas fa-arrows-alt me-1"></i>Move
                            </button>
                            <button class="action-btn" style="background:#e5e7eb;color:#111827" data-action="reserve" data-stock-id="${item.id}" data-product-name="${item.product_name}">
                                <i class="fas fa-bookmark me-1"></i>Reserve
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });
    }
    
    getStatusClass(available) {
        if (available === 0) return 'status-out';
        if (available <= 5) return 'status-low';
        return 'status-available';
    }
    
    showEmptyBin() {
        document.getElementById('stockItemsContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('emptyState').innerHTML = `
            <i class="fas fa-box-open"></i>
            <h4>Empty Bin</h4>
            <p>Bin ${this.currentBin.code} is empty</p>
            <button class="btn btn-success mt-3" onclick="binDetailsManager.showAssignStockModal()">
                <i class="fas fa-plus me-2"></i>Assign Stock to Bin
            </button>
        `;
    }

    async submitRenameBin() {
        const input = document.getElementById('renameBinInput');
        if (!input) return;
        const newCode = (input.value || '').toUpperCase().trim();
        if (!newCode) { alert('Enter a new bin code.'); return; }
        const regex = /^B\d{4}$/;
        if (!regex.test(newCode)) {
            alert('Invalid code format. Use B#### (e.g., B1003).');
            return;
        }
        const btn = document.getElementById('renameBinBtn');
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        try {
            const res = await fetch(`/warehouses/api/bin/${this.currentBin.code}/rename`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ new_code: newCode })
            });
            const data = await res.json();
            if (res.ok && data.success) {
                // Update current state and UI
                this.currentBin.code = newCode;
                const codeEl = document.getElementById('binCodeText');
                if (codeEl) codeEl.textContent = newCode;
                input.value = '';
                // Small success toast via success modal
                document.getElementById('successMessage').textContent = `Bin code changed to ${newCode}`;
                new bootstrap.Modal(document.getElementById('successModal')).show();
            } else {
                alert(data.error || 'Failed to rename bin');
            }
        } catch (e) {
            alert('Network error while renaming bin');
        } finally {
            btn.innerHTML = original;
            btn.disabled = false;
        }
    }

    async submitDeleteBin() {
        if (!confirm(`Delete bin ${this.currentBin.code}? This cannot be undone.`)) return;
        try {
            const res = await fetch(`/warehouses/api/bin/${this.currentBin.code}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (res.ok && data.success) {
                // Close details modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('binDetailsModal'));
                if (modal) modal.hide();
                this.cleanupModalBackdrop();
                // Notify success
                document.getElementById('successMessage').textContent = data.message || 'Bin deleted';
                new bootstrap.Modal(document.getElementById('successModal')).show();
            } else {
                alert(data.error || 'Failed to delete bin');
            }
        } catch (e) {
            alert('Network error while deleting bin');
        }
    }
    
    showLoading() {
        document.getElementById('binInfo').style.display = 'none';
        document.getElementById('stockItemsContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('emptyState').innerHTML = `
            <i class="fas fa-spinner fa-spin"></i>
            <h4>Loading...</h4>
            <p>Fetching bin data</p>
        `;
    }
    
    showError(message) {
        document.getElementById('binInfo').style.display = 'none';
        document.getElementById('stockItemsContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('emptyState').innerHTML = `
            <i class="fas fa-exclamation-triangle text-warning"></i>
            <h4>Error</h4>
            <p>${message}</p>
        `;
    }
    
    // Include all the transaction methods from the scanner (abbreviated for space)
    showTransactionModal(action, stockItemId, productName) {
        if (action === 'transfer') {
            this.showMoveStockModal(stockItemId, productName);
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
        const title = document.getElementById('transactionTitle');
        const form = document.getElementById('transactionForm');
        
        title.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} - ${productName}`;
        
        const currentItem = this.getStockItemById(stockItemId) || {};
        const availableCalc = Math.max(0, Number(currentItem.on_hand || 0) - Number(currentItem.qty_reserved || 0));
        const metricsHtml = action === 'reserve' ? `
            <div class="row">
                <div class="col-md-12">
                    <div class="d-flex gap-2 mb-2">
                        <span class="badge bg-success">On Hand: ${currentItem.on_hand ?? 0}</span>
                        <span class="badge bg-info">Reserved: ${currentItem.qty_reserved ?? 0}</span>
                        <span class="badge bg-primary">Available: ${availableCalc}</span>
                    </div>
                </div>
            </div>
        ` : '';
        
        const actionLabels = {
            'pick': 'Ship/Pick',
            'receive': 'Receive/Restock',
            'adjust': 'Adjust Stock',
            'transfer': 'Transfer Stock',
            'reserve': 'Reserve Stock'
        };
        
        form.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Action Type</label>
                        <input type="text" class="form-control" value="${actionLabels[action]}" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Product</label>
                        <input type="text" class="form-control" value="${productName}" readonly>
                    </div>
                </div>
            </div>
            ${metricsHtml}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="transactionQuantity" min="1" value="1" ${action === 'reserve' ? `max="${availableCalc}"` : ''}>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Transaction Type</label>
                        <select class="form-select" id="transactionType">
                            ${this.getTransactionTypeOptions(action)}
                        </select>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="transactionNotes" rows="3" 
                          placeholder="Enter any additional notes for this transaction"></textarea>
            </div>
        `;
        
        // Store current transaction data
        this.currentTransaction = {
            stockItemId: stockItemId,
            action: action
        };
        
        modal.show();
    }
    
    getTransactionTypeOptions(action) {
        const options = {
            'pick': '<option value="ship">Ship/Pick</option>',
            'receive': '<option value="receive">Receive</option>',
            'adjust': '<option value="adjust">Adjust</option>',
            'transfer': '<option value="reserve">Reserve</option><option value="release">Release</option>'
        };
        return options[action] || '<option value="adjust">Adjust</option>';
    }
    
    async submitTransaction() {
        const quantity = parseInt(document.getElementById('transactionQuantity').value);
        const typeEl = document.getElementById('transactionType');
        const transactionType = typeEl ? typeEl.value : (this.currentTransaction?.action || 'adjust');
        const postType = (this.currentTransaction && this.currentTransaction.action === 'reserve') ? 'reserve' : String(transactionType || '').toLowerCase();
        const notes = document.getElementById('transactionNotes').value;
        
        if (!quantity || quantity <= 0) {
            alert('Please enter a valid quantity');
            return;
        }
        
        if (this.currentTransaction && this.currentTransaction.action === 'reserve') {
            const item = this.getStockItemById(this.currentTransaction.stockItemId);
            const available = Math.max(0, Number(item?.on_hand || 0) - Number(item?.qty_reserved || 0));
            if (quantity > available) {
                alert(`Cannot reserve more than available (${available}).`);
                return;
            }
        }
        
        const submitBtn = document.getElementById('submitTransaction');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/scanner/api/transaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    stock_item_id: this.currentTransaction.stockItemId,
                    type: postType,
                    quantity_change: quantity,
                    notes: notes
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                this.showSuccess(data);
                // Refresh bin data
                this.showBinDetails(this.currentBin.code);
            } else {
                alert('Error: ' + (data.error || 'Transaction failed'));
            }
        } catch (error) {
            console.error('Transaction error:', error);
            alert('Network error occurred');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
    
    showSuccess(data) {
        // Close transaction modal if open
        const transactionModal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
        if (transactionModal) transactionModal.hide();
        
        // Show success modal
        const qty = data.transaction ? data.transaction.quantity_change : (data.quantity_change || data.quantity || '');
        const type = data.transaction ? data.transaction.type : (data.type || '');
        document.getElementById('successMessage').textContent = 
            `Successfully ${type || 'processed'} ${qty} unit(s).`;
        
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        successModal.show();
    }
    
    async showMoveStockModal(stockItemId, productName) {
        // Get the current stock item to populate the modal
        const stockItem = this.getStockItemById(stockItemId);
        if (!stockItem) {
            alert('Stock item not found');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('moveStockModal'));
        
        // Populate the "From" section with current stock item data
        document.getElementById('moveCurrentBinCode').value = this.currentBin.code;
        document.getElementById('moveCurrentLocation').value = this.currentBin.location_code || 'Not assigned';
        document.getElementById('moveCurrentWarehouse').value = this.currentBin.warehouse_name || 'Not assigned';
        document.getElementById('moveProductName').value = productName;
        const availableForMove = Math.max(0, Number(stockItem.on_hand || 0) - Number(stockItem.qty_reserved || 0));
        document.getElementById('moveAvailableQuantity').value = availableForMove;
        // Reset quantities
        const qtyInput = document.getElementById('moveQuantity');
        const rsvInput = document.getElementById('moveReservedQuantity');
        if (qtyInput) qtyInput.value = '0';
        if (rsvInput) rsvInput.value = '0';
        
        // Reset the destination section
        const destSelect = document.getElementById('moveDestinationBinSelect');
        const destHidden = document.getElementById('moveDestinationBinId');
        if (destSelect) destSelect.innerHTML = '<option value="">Select Destination Bin</option>';
        if (destHidden) destHidden.value = '';
        document.getElementById('moveDestinationLocation').value = '';
        document.getElementById('moveDestinationWarehouse').value = '';
        document.getElementById('moveQuantity').value = '1';
        document.getElementById('moveNotes').value = '';
        
        // Store current transaction data
        this.currentMoveTransaction = {
            stockItemId: stockItemId,
            productName: productName
        };
        
        // Determine product id for filtering (if available) and initialize toggle
        const productIdForMove = (stockItem && stockItem.product_id) ? stockItem.product_id : null;
        const toggleContainer = document.getElementById('moveShowSameProductContainer');
        const toggle = document.getElementById('moveShowSameProduct');
        if (productIdForMove) {
            if (toggleContainer) toggleContainer.style.display = 'block';
            if (toggle) {
                toggle.checked = false; // default to empty bins
                // Re-populate on toggle change
                toggle.onchange = () => {
                    this.populateDestinationBins(productIdForMove);
                };
            }
        } else {
            if (toggleContainer) toggleContainer.style.display = 'none';
            if (toggle) toggle.checked = false;
        }

        // Load eligible destination bins (empty or same-product per toggle; require location)
        try {
            await this.populateDestinationBins(productIdForMove);
        } catch (e) {
            console.error('Failed to populate destination bins:', e);
        }

        modal.show();
    }
    
    getStockItemById(stockItemId) {
        // Find the stock item in the current bin's stock items
        if (!this.currentBin || !this.currentBin.stock_items) {
            return null;
        }
        
        return this.currentBin.stock_items.find(item => item.id === stockItemId);
    }

    async populateDestinationBins(productId) {
        const select = document.getElementById('moveDestinationBinSelect');
        if (!select) return;
        const url = new URL('/stock/api/bin-availability', window.location.origin);
        if (productId) url.searchParams.set('product_id', productId);
        const res = await fetch(url.toString(), { credentials: 'same-origin' });
        const data = await res.json();
        const bins = Array.isArray(data.bins) ? data.bins : [];
        // Filter: require location, hide other-product occupied; if no product, only empty.
        // If product present and toggle on, show same-product bins; else show empty bins.
        const showSameOnly = !!(document.getElementById('moveShowSameProduct') && document.getElementById('moveShowSameProduct').checked);
        const filtered = bins.filter(b => {
            if (!b.location_id) return false;
            if (b.occupied_by_other_product) return false;
            if (!productId) return !!b.is_empty;
            return showSameOnly ? !!b.occupied_by_same_product : !!b.is_empty;
        });
        // Build options: code - location
        const options = ['<option value="">Select Destination Bin</option>']
            .concat(filtered.map(b => {
                const codeText = (b.code && String(b.code).trim()) ? b.code : `Bin ${b.id}`;
                const locText = (b.location_code && String(b.location_code).trim()) ? ` - ${b.location_code}` : '';
                const whText = (b.warehouse_name && String(b.warehouse_name).trim()) ? b.warehouse_name : '';
                return `<option value="${b.id}" data-location="${b.location_code || ''}" data-warehouse="${whText}">${codeText + locText}</option>`;
            }));
        select.innerHTML = options.join('');
        // Wire change to update hidden id and location & warehouse summary
        select.onchange = () => {
            const val = select.value;
            document.getElementById('moveDestinationBinId').value = val || '';
            const opt = select.options[select.selectedIndex];
            const loc = opt ? (opt.getAttribute('data-location') || '') : '';
            const wh = opt ? (opt.getAttribute('data-warehouse') || '') : '';
            document.getElementById('moveDestinationLocation').value = loc;
            document.getElementById('moveDestinationWarehouse').value = wh;
        };
    }
    
    async submitMoveStock() {
        try {
            const submitBtn = document.getElementById('submitMoveStock');
            const destBinId = (document.getElementById('moveDestinationBinId')?.value || '').trim();
            const qtyStr = document.getElementById('moveQuantity')?.value || '0';
            const quantity = parseInt(qtyStr, 10) || 0;
            const rsvStr = document.getElementById('moveReservedQuantity')?.value || '0';
            const reservedQty = parseInt(rsvStr, 10) || 0;
            const notes = document.getElementById('moveNotes')?.value || '';

            if (!this.currentMoveTransaction || !this.currentMoveTransaction.stockItemId) {
                alert('No stock item selected');
                return;
            }
            if (!destBinId) {
                alert('Please select a destination bin');
                return;
            }
            if (quantity < 0 || reservedQty < 0) {
                alert('Quantities cannot be negative');
                return;
            }
            if (quantity === 0 && reservedQty === 0) {
                alert('Enter a quantity or reserved amount to move');
                return;
            }

            // Validate against available on current item
            const stockItem = this.getStockItemById(this.currentMoveTransaction.stockItemId);
            const available = stockItem ? Math.max(0, Number(stockItem.on_hand || 0) - Number(stockItem.qty_reserved || 0)) : 0;
            const reservedAvailable = stockItem ? Number(stockItem.qty_reserved || 0) : 0;
            if (quantity > available) {
                alert(`Cannot move more than available (${available}).`);
                return;
            }
            if (reservedQty > reservedAvailable) {
                alert(`Cannot move more reserved than exists (${reservedAvailable}).`);
                return;
            }

            const originalHtml = submitBtn ? submitBtn.innerHTML : '';
            if (submitBtn) { submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Moving...'; submitBtn.disabled = true; }

            const res = await fetch('/scanner/api/transaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    type: 'stock_move',
                    source_stock_id: this.currentMoveTransaction.stockItemId,
                    dest_bin_id: destBinId,
                    quantity: quantity,
                    reserved_quantity: reservedQty,
                    notes: notes
                })
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                throw new Error(data.error || 'Failed to move stock');
            }

            // Close move modal and show success
            const moveModal = bootstrap.Modal.getInstance(document.getElementById('moveStockModal'));
            if (moveModal) moveModal.hide();
            this.cleanupModalBackdrop();

            document.getElementById('successMessage').textContent = `Moved ${quantity} unit(s) to selected bin.`;
            new bootstrap.Modal(document.getElementById('successModal')).show();

            // Refresh current bin details
            this.showBinDetails(this.currentBin.code);
        } catch (e) {
            alert(e.message || 'Failed to move stock');
        } finally {
            const submitBtn = document.getElementById('submitMoveStock');
            if (submitBtn) { submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>Move Stock'; submitBtn.disabled = false; }
        }
    }

    setMoveAllStock() {
        // Get the available quantity from the readonly field
        const availableQuantity = document.getElementById('moveAvailableQuantity').value;
        if (availableQuantity && !isNaN(availableQuantity)) {
            document.getElementById('moveQuantity').value = availableQuantity;
        }
    }
    
    async searchLocations(query) {
        const autocomplete = document.getElementById('locationAutocomplete');
        
        if (!query || query.length < 1) {
            autocomplete.style.display = 'none';
            return;
        }
        
        try {
            const response = await fetch(`/warehouses/api/locations/search?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (data.success && data.locations.length > 0) {
                this.displayLocationResults(data.locations);
            } else {
                autocomplete.style.display = 'none';
            }
        } catch (error) {
            console.error('Error searching locations:', error);
            autocomplete.style.display = 'none';
        }
    }
    
    displayLocationResults(locations) {
        const autocomplete = document.getElementById('locationAutocomplete');
        
        autocomplete.innerHTML = locations.map(location => `
            <div class="autocomplete-item" data-location-code="${location.full_code}" data-location-id="${location.id}">
                <div class="fw-bold">${location.full_code}</div>
                <div class="text-muted small">${location.name || 'No name'}</div>
            </div>
        `).join('');
        
        // Add click handlers to autocomplete items
        autocomplete.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', () => {
                const locationCode = item.dataset.locationCode;
                document.getElementById('changeLocationInput').value = locationCode;
                document.getElementById('changeLocationNewLocation').value = locationCode;
                autocomplete.style.display = 'none';
            });
        });
        
        autocomplete.style.display = 'block';
    }
    
    cleanupModalBackdrop() {
        // Remove any backdrop elements that might be left behind
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Remove modal-open class from body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
    
    showChangeLocationModal() {
        if (!this.currentBin) {
            alert('No bin selected');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('changeLocationModal'));
        
        // Populate the modal with current bin information
        document.getElementById('changeLocationBinCode').value = this.currentBin.code;
        document.getElementById('changeLocationCurrentLocation').value = this.currentBin.location_code || 'Not assigned';
        
        // Reset the new location field
        document.getElementById('changeLocationInput').value = '';
        document.getElementById('changeLocationNewLocation').value = '';
        document.getElementById('changeLocationNotes').value = '';
        
        // Hide autocomplete dropdown
        document.getElementById('locationAutocomplete').style.display = 'none';
        
        modal.show();
    }
    
    async submitChangeLocation() {
        const newLocationCode = document.getElementById('changeLocationInput').value.trim();
        const notes = document.getElementById('changeLocationNotes').value;
        
        if (!newLocationCode) {
            alert('Please enter a new location code');
            return;
        }
        
        const submitBtn = document.getElementById('submitChangeLocation');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch(`/warehouses/api/bin/${this.currentBin.code}/change-location`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    new_location_code: newLocationCode,
                    notes: notes
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Close the change location modal properly
                const changeLocationModal = bootstrap.Modal.getInstance(document.getElementById('changeLocationModal'));
                if (changeLocationModal) {
                    changeLocationModal.hide();
                }
                
                // Clean up any lingering backdrop
                setTimeout(() => {
                    this.cleanupModalBackdrop();
                    
                    // Show success message
                    document.getElementById('successMessage').textContent = 
                        `Successfully changed bin location to ${newLocationCode}`;
                    
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    
                    // Refresh bin data
                    this.showBinDetails(this.currentBin.code);
                }, 300); // Small delay to ensure modal is fully closed
            } else {
                alert('Error: ' + (data.error || 'Failed to change location'));
            }
        } catch (error) {
            console.error('Change location error:', error);
            alert('Network error occurred');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
    
    // Include other methods like showAssignStockModal, showChangeLocationModal, etc.
    // (abbreviated for space - these would be similar to the scanner implementation)
    async showAssignStockModal() {
        if (!this.currentBin) {
            alert('No bin selected');
            return;
        }
        // Populate fields
        const binCodeInput = document.getElementById('assignBinCode');
        const locInput = document.getElementById('assignLocationCode');
        const productSelect = document.getElementById('assignProductId');
        document.getElementById('assignQuantity').value = '1';
        document.getElementById('assignBatchId').value = '';
        document.getElementById('assignExpiryDate').value = '';
        if (binCodeInput) binCodeInput.value = this.currentBin.code || '';
        if (locInput) locInput.value = this.currentBin.location_code || 'Not assigned';

        // Load products
        try {
            const res = await fetch('/scanner/api/products/available', { credentials: 'same-origin' });
            const data = await res.json();
            if (res.ok && data.success && Array.isArray(data.products)) {
                productSelect.innerHTML = '<option value="">Select a product...</option>' +
                    data.products.map(p => `<option value="${p.id}">${p.name}${p.sku ? ' (' + p.sku + ')' : ''}</option>`).join('');
            } else {
                productSelect.innerHTML = '<option value="">No products available</option>';
            }
        } catch (e) {
            productSelect.innerHTML = '<option value="">Error loading products</option>';
        }

        new bootstrap.Modal(document.getElementById('assignStockModal')).show();
    }

    async submitAssignStock() {
        if (!this.currentBin) return;
        const productId = document.getElementById('assignProductId').value;
        const qtyStr = document.getElementById('assignQuantity').value;
        const quantity = parseInt(qtyStr || '0', 10);
        const batchId = document.getElementById('assignBatchId').value || null;
        const expiryDate = document.getElementById('assignExpiryDate').value || null;

        if (!productId) { alert('Please select a product.'); return; }
        if (!quantity || quantity <= 0) { alert('Please enter a valid quantity.'); return; }

        const btn = document.getElementById('submitAssignStock');
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Assigning...';
        btn.disabled = true;

        try {
            // Use scanner transaction API with bin_assign type to avoid capacity dependency
            const res = await fetch('/scanner/api/transaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    type: 'bin_assign',
                    bin_code: this.currentBin.code,
                    product_id: productId,
                    quantity: quantity,
                    batch_id: batchId,
                    expiry_date: expiryDate
                })
            });
            const data = await res.json();
            if (res.ok && data.success) {
                // Close assign modal
                const assignModal = bootstrap.Modal.getInstance(document.getElementById('assignStockModal'));
                if (assignModal) assignModal.hide();
                this.cleanupModalBackdrop();
                // Show success and refresh
                document.getElementById('successMessage').textContent = 'Stock assigned to bin successfully';
                new bootstrap.Modal(document.getElementById('successModal')).show();
                // Refresh details to show new stock
                this.showBinDetails(this.currentBin.code);
            } else {
                alert(data.error || 'Failed to assign stock');
            }
        } catch (e) {
            alert('Network error while assigning stock');
        } finally {
            btn.innerHTML = original;
            btn.disabled = false;
        }
    }

    async showReservePrompt(stockItemId, productName) {
        const qtyStr = prompt(`Reserve quantity for ${productName}:`, '1');
        if (qtyStr === null) return;
        const qty = parseInt(qtyStr, 10);
        if (!qty || qty <= 0) { alert('Enter a valid quantity'); return; }
        try {
            const res = await fetch('/scanner/api/transaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ type: 'reserve', stock_item_id: stockItemId, quantity: qty })
            });
            const data = await res.json();
            if (!res.ok || !data.success) { throw new Error(data.error || 'Failed to reserve'); }
            // Refresh bin data after reservation
            this.showBinDetails(this.currentBin.code);
            document.getElementById('successMessage').textContent = `Reserved ${qty} unit(s) of ${productName}`;
            new bootstrap.Modal(document.getElementById('successModal')).show();
        } catch (e) {
            alert(e.message || 'Reservation failed');
        }
    }
}

// Initialize global bin details manager
window.binDetailsManager = new BinDetailsManager();
</script>
