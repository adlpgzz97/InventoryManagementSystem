<!-- Bin Details Modal -->
<div class="modal fade" id="binDetailsModal" tabindex="-1" aria-labelledby="binDetailsLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="binDetailsLabel">
                    <i class="fas fa-box me-2"></i>Bin Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Bin Information -->
                <div id="binInfo" class="location-info mb-4" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-box me-2"></i>Bin Details</h5>
                            <div id="binDetails"></div>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-warehouse me-2"></i>Location Info</h5>
                            <div id="locationDetails"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Stock Items -->
                <div id="stockItemsContainer" class="stock-items-container" style="display: none;">
                    <h5><i class="fas fa-boxes me-2"></i>Products in Bin</h5>
                    <div id="stockItemsList"></div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <h4>Loading Bin Details...</h4>
                    <p>Please wait while we fetch the bin information</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Modal -->
<div class="modal fade transaction-modal" id="transactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>
                    <span id="transactionTitle">Perform Action</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="transactionForm">
                    <!-- Form will be dynamically populated -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitTransaction">
                    <i class="fas fa-check me-1"></i>Submit Transaction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Stock Modal -->
<div class="modal fade" id="assignStockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Assign Stock to Bin
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Bin Code</label>
                            <input type="text" class="form-control" id="assignBinCode" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="assignLocationCode" readonly>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Product *</label>
                            <select class="form-select" id="assignProductId" required>
                                <option value="">Select a product...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="assignQuantity" min="1" value="1" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Batch ID</label>
                            <input type="text" class="form-control" id="assignBatchId" placeholder="Optional batch identifier">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Expiry Date</label>
                            <input type="date" class="form-control" id="assignExpiryDate">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="assignNotes" rows="3" 
                              placeholder="Enter any additional notes for this assignment"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submitAssignStock">
                    <i class="fas fa-check me-1"></i>Assign Stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Change Location Modal -->
<div class="modal fade" id="changeLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    Change Bin Location
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Bin Code</label>
                            <input type="text" class="form-control" id="changeLocationBinCode" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Current Location</label>
                            <input type="text" class="form-control" id="changeLocationCurrentLocation" readonly>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">New Location *</label>
                    <div class="position-relative">
                        <input type="text" 
                               class="form-control" 
                               id="changeLocationInput" 
                               placeholder="Type location code or scan barcode..."
                               autocomplete="off"
                               required>
                        <div id="locationAutocomplete" class="autocomplete-dropdown" style="display: none;"></div>
                    </div>
                    <input type="hidden" id="changeLocationNewLocation" value="">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Type to search locations or scan a location barcode
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="changeLocationNotes" rows="3" 
                              placeholder="Enter any additional notes for this location change"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="submitChangeLocation">
                    <i class="fas fa-check me-1"></i>Change Location
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Move Stock Modal -->
<div class="modal fade" id="moveStockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-arrows-alt me-2"></i>
                    Move Stock Between Bins
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Current Bin (Left Side) -->
                    <div class="col-md-5">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-box me-2"></i>From (Current Bin)</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Bin Code</label>
                                    <input type="text" class="form-control" id="moveCurrentBinCode" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-control" id="moveCurrentLocation" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Warehouse</label>
                                    <input type="text" class="form-control" id="moveCurrentWarehouse" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Product</label>
                                    <input type="text" class="form-control" id="moveProductName" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Quantity On-Hand</label>
                                    <input type="text" class="form-control" id="moveAvailableQuantity" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Arrow -->
                    <div class="col-md-2 d-flex align-items-center justify-content-center">
                        <div class="text-center">
                            <i class="fas fa-arrow-right fa-2x text-primary"></i>
                            <div class="mt-2">
                                <label class="form-label">Quantity to Move</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="moveQuantity" min="1" value="1">
                                    <button class="btn btn-outline-secondary" type="button" id="moveAllStock">
                                        All Stock
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Destination Bin (Right Side) -->
                    <div class="col-md-5">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>To (Destination Bin)</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Destination Bin *</label>
                                    <div class="position-relative">
                                        <input type="text" 
                                               class="form-control" 
                                               id="moveDestinationBinInput" 
                                               placeholder="Type bin code or scan barcode..."
                                               autocomplete="off"
                                               required>
                                        <div id="destinationBinAutocomplete" class="autocomplete-dropdown" style="display: none;"></div>
                                    </div>
                                    <input type="hidden" id="moveDestinationBinId" value="">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Type to search bins or scan a bin barcode
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Destination Location</label>
                                    <input type="text" class="form-control" id="moveDestinationLocation" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Destination Warehouse</label>
                                    <input type="text" class="form-control" id="moveDestinationWarehouse" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-control" id="moveNotes" rows="3" 
                                              placeholder="Enter any additional notes for this move"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitMoveStock">
                    <i class="fas fa-check me-1"></i>Move Stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <i class="fas fa-check-circle text-success" style="font-size: 48px;"></i>
                <h5 class="mt-3">Operation Successful!</h5>
                <p id="successMessage" class="text-muted"></p>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">Continue</button>
            </div>
        </div>
    </div>
</div>

<style>
.location-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 5px solid #4CAF50;
}

.stock-items-container {
    max-height: 400px;
    overflow-y: auto;
}

.stock-item-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.stock-item-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.action-btn {
    flex: 1;
    min-width: 120px;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.action-btn:hover {
    /* Removed floating effect */
}

.btn-pick { background: #2196F3; color: white; }
.btn-pick:hover { background: #1976D2; }

.btn-restock { background: #4CAF50; color: white; }
.btn-restock:hover { background: #388E3C; }

.btn-move { background: #FF9800; color: white; }
.btn-move:hover { background: #F57C00; }

.btn-adjust { background: #9C27B0; color: white; }
.btn-adjust:hover { background: #7B1FA2; }

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-available { background: #4CAF50; }
.status-low { background: #FF9800; }
.status-out { background: #F44336; }

.transaction-modal .modal-content {
    border-radius: 15px;
}

.transaction-modal .modal-header {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border-radius: 15px 15px 0 0;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #ccc;
}

.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1050;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.autocomplete-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.autocomplete-item:hover {
    background-color: #f8f9fa;
}

.autocomplete-item.selected {
    background-color: #e3f2fd;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item .location-code {
    font-weight: bold;
    color: #2196F3;
}

.autocomplete-item .warehouse-name {
    font-size: 0.9em;
    color: #666;
}
</style>

<script>
class BinDetailsManager {
    constructor() {
        this.currentBin = null;
        this.availableLocations = [];
        this.availableBins = [];
        this.initializeEventListeners();
    }
    
    initializeEventListeners() {
        // Handle transaction submission
        document.getElementById('submitTransaction').addEventListener('click', () => {
            this.submitTransaction();
        });
        
        // Handle assign stock submission
        document.getElementById('submitAssignStock').addEventListener('click', () => {
            this.submitAssignStock();
        });
        
        // Handle change location submission
        document.getElementById('submitChangeLocation').addEventListener('click', () => {
            this.submitChangeLocation();
        });
        
        // Handle move stock submission
        document.getElementById('submitMoveStock').addEventListener('click', () => {
            this.submitMoveStock();
        });
        
        // Handle "All Stock" button
        document.getElementById('moveAllStock').addEventListener('click', () => {
            this.setMoveAllStock();
        });
        
        // Handle location search input
        document.getElementById('changeLocationInput').addEventListener('input', (e) => {
            this.searchLocations(e.target.value);
        });
        
        // Handle location input focus
        document.getElementById('changeLocationInput').addEventListener('focus', (e) => {
            if (e.target.value.length > 0) {
                this.searchLocations(e.target.value);
            }
        });
        
        // Handle clicks outside autocomplete dropdown
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#changeLocationInput') && !e.target.closest('#locationAutocomplete')) {
                document.getElementById('locationAutocomplete').style.display = 'none';
            }
        });
        
        // Handle modal cleanup when modals are closed
        document.getElementById('changeLocationModal').addEventListener('hidden.bs.modal', () => {
            this.cleanupModalBackdrop();
        });
        
        document.getElementById('successModal').addEventListener('hidden.bs.modal', () => {
            this.cleanupModalBackdrop();
        });
        
        // Handle action button clicks using event delegation
        document.addEventListener('click', (e) => {
            if (e.target.closest('.action-btn')) {
                const button = e.target.closest('.action-btn');
                const action = button.dataset.action;
                const stockId = button.dataset.stockId;
                const productName = button.dataset.productName;
                
                if (action && stockId && productName) {
                    this.showTransactionModal(action, stockId, productName);
                }
            }
        });
    }
    
    async showBinDetails(binCode) {
        const modal = new bootstrap.Modal(document.getElementById('binDetailsModal'));
        
        // Show loading state
        this.showLoading();
        
        try {
            const response = await fetch(`/warehouses/api/bin/${binCode}`, {
                credentials: 'same-origin'
            });
            const data = await response.json();
            
            if (response.ok) {
                this.displayBinData(data);
                modal.show();
            } else {
                this.showError(data.error || 'Bin not found');
                modal.show();
            }
        } catch (error) {
            console.error('Error fetching bin data:', error);
            this.showError('Network error occurred');
            modal.show();
        }
    }
    
    displayBinData(data) {
        this.currentBin = data.bin;
        this.currentBin.stock_items = data.stock_items;
        
        // Show bin info
        document.getElementById('binInfo').style.display = 'block';
        
        document.getElementById('binDetails').innerHTML = `
            <p class="mb-1"><strong>Bin Code:</strong> <span id="binCodeText">${data.bin.code}</span></p>
            <div class="input-group input-group-sm mb-2" style="max-width: 240px;">
                <span class="input-group-text">New Code</span>
                <input type="text" class="form-control" id="renameBinInput" placeholder="B1234" maxlength="5">
                <button class="btn btn-outline-primary" id="renameBinBtn" title="Rename bin">
                    <i class="fas fa-pen"></i>
                </button>
            </div>
            <p><strong>Location:</strong> ${data.bin.location_code || 'Not assigned'}</p>
            <button class="btn btn-warning btn-sm mt-2" onclick="binDetailsManager.showChangeLocationModal()">
                <i class="fas fa-map-marker-alt me-1"></i>Change Location
            </button>
            <button class="btn btn-outline-danger btn-sm mt-2 ms-2" id="deleteBinBtn" title="Delete bin">
                <i class="fas fa-trash"></i> Delete Bin
            </button>
        `;
        
        document.getElementById('locationDetails').innerHTML = `
            <p><strong>Warehouse:</strong> ${data.bin.warehouse_name || 'Not assigned'}</p>
            <p><strong>Warehouse Code:</strong> ${data.bin.warehouse_code || 'Not assigned'}</p>
            <p><strong>Address:</strong> ${data.bin.warehouse_address || 'Not assigned'}</p>
        `;
        
        // Check if bin has stock items
        if (data.bin.has_stock) {
            this.displayStockItems(data.stock_items);
            document.getElementById('stockItemsContainer').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            // Disable delete when has stock
            const delBtn = document.getElementById('deleteBinBtn');
            if (delBtn) { delBtn.disabled = true; delBtn.title = 'Cannot delete a bin that has stock'; }
        } else {
            this.showEmptyBin();
            const delBtn = document.getElementById('deleteBinBtn');
            if (delBtn) { delBtn.disabled = false; delBtn.title = 'Delete this empty bin'; }
        }

        // Wire rename/delete actions
        const renameBtn = document.getElementById('renameBinBtn');
        if (renameBtn) {
            renameBtn.onclick = () => this.submitRenameBin();
        }
        const deleteBtn = document.getElementById('deleteBinBtn');
        if (deleteBtn) {
            deleteBtn.onclick = () => this.submitDeleteBin();
        }
    }
    
    displayStockItems(stockItems) {
        const container = document.getElementById('stockItemsList');
        container.innerHTML = '';
        
        stockItems.forEach(item => {
            const card = document.createElement('div');
            card.className = 'stock-item-card';
            
            const statusClass = this.getStatusClass(item.on_hand);
            
            card.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h6 class="mb-1">${item.product_name}</h6>
                        <small class="text-muted">SKU: ${item.sku}</small>
                        ${item.barcode ? `<br><small class="text-muted">Barcode: ${item.barcode}</small>` : ''}
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator ${statusClass}"></span>
                            <div>
                                <div><strong>Available:</strong> ${item.on_hand}</div>
                                <div><strong>Reserved:</strong> ${item.qty_reserved}</div>
                                <div><strong>Total:</strong> ${item.total_qty}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="action-buttons">
                            <button class="action-btn btn-pick" data-action="pick" data-stock-id="${item.id}" data-product-name="${item.product_name}">
                                <i class="fas fa-hand-paper me-1"></i>Pick
                            </button>
                            <button class="action-btn btn-restock" data-action="receive" data-stock-id="${item.id}" data-product-name="${item.product_name}">
                                <i class="fas fa-plus me-1"></i>Restock
                            </button>
                            <button class="action-btn btn-adjust" data-action="adjust" data-stock-id="${item.id}" data-product-name="${item.product_name}">
                                <i class="fas fa-edit me-1"></i>Adjust
                            </button>
                            <button class="action-btn btn-move" data-action="transfer" data-stock-id="${item.id}" data-product-name="${item.product_name}">
                                <i class="fas fa-arrows-alt me-1"></i>Move
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });
    }
    
    getStatusClass(available) {
        if (available === 0) return 'status-out';
        if (available <= 5) return 'status-low';
        return 'status-available';
    }
    
    showEmptyBin() {
        document.getElementById('stockItemsContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('emptyState').innerHTML = `
            <i class="fas fa-box-open"></i>
            <h4>Empty Bin</h4>
            <p>Bin ${this.currentBin.code} is empty</p>
            <button class="btn btn-success mt-3" onclick="binDetailsManager.showAssignStockModal()">
                <i class="fas fa-plus me-2"></i>Assign Stock to Bin
            </button>
        `;
    }

    async submitRenameBin() {
        const input = document.getElementById('renameBinInput');
        if (!input) return;
        const newCode = (input.value || '').toUpperCase().trim();
        if (!newCode) { alert('Enter a new bin code.'); return; }
        const regex = /^B\d{4}$/;
        if (!regex.test(newCode)) {
            alert('Invalid code format. Use B#### (e.g., B1003).');
            return;
        }
        const btn = document.getElementById('renameBinBtn');
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        try {
            const res = await fetch(`/warehouses/api/bin/${this.currentBin.code}/rename`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ new_code: newCode })
            });
            const data = await res.json();
            if (res.ok && data.success) {
                // Update current state and UI
                this.currentBin.code = newCode;
                const codeEl = document.getElementById('binCodeText');
                if (codeEl) codeEl.textContent = newCode;
                input.value = '';
                // Small success toast via success modal
                document.getElementById('successMessage').textContent = `Bin code changed to ${newCode}`;
                new bootstrap.Modal(document.getElementById('successModal')).show();
            } else {
                alert(data.error || 'Failed to rename bin');
            }
        } catch (e) {
            alert('Network error while renaming bin');
        } finally {
            btn.innerHTML = original;
            btn.disabled = false;
        }
    }

    async submitDeleteBin() {
        if (!confirm(`Delete bin ${this.currentBin.code}? This cannot be undone.`)) return;
        try {
            const res = await fetch(`/warehouses/api/bin/${this.currentBin.code}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (res.ok && data.success) {
                // Close details modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('binDetailsModal'));
                if (modal) modal.hide();
                this.cleanupModalBackdrop();
                // Notify success
                document.getElementById('successMessage').textContent = data.message || 'Bin deleted';
                new bootstrap.Modal(document.getElementById('successModal')).show();
            } else {
                alert(data.error || 'Failed to delete bin');
            }
        } catch (e) {
            alert('Network error while deleting bin');
        }
    }
    
    showLoading() {
        document.getElementById('binInfo').style.display = 'none';
        document.getElementById('stockItemsContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('emptyState').innerHTML = `
            <i class="fas fa-spinner fa-spin"></i>
            <h4>Loading...</h4>
            <p>Fetching bin data</p>
        `;
    }
    
    showError(message) {
        document.getElementById('binInfo').style.display = 'none';
        document.getElementById('stockItemsContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('emptyState').innerHTML = `
            <i class="fas fa-exclamation-triangle text-warning"></i>
            <h4>Error</h4>
            <p>${message}</p>
        `;
    }
    
    // Include all the transaction methods from the scanner (abbreviated for space)
    showTransactionModal(action, stockItemId, productName) {
        if (action === 'transfer') {
            this.showMoveStockModal(stockItemId, productName);
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
        const title = document.getElementById('transactionTitle');
        const form = document.getElementById('transactionForm');
        
        title.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} - ${productName}`;
        
        const actionLabels = {
            'pick': 'Ship/Pick',
            'receive': 'Receive/Restock',
            'adjust': 'Adjust Stock',
            'transfer': 'Transfer Stock'
        };
        
        form.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Action Type</label>
                        <input type="text" class="form-control" value="${actionLabels[action]}" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Product</label>
                        <input type="text" class="form-control" value="${productName}" readonly>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="transactionQuantity" min="1" value="1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Transaction Type</label>
                        <select class="form-select" id="transactionType">
                            ${this.getTransactionTypeOptions(action)}
                        </select>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="transactionNotes" rows="3" 
                          placeholder="Enter any additional notes for this transaction"></textarea>
            </div>
        `;
        
        // Store current transaction data
        this.currentTransaction = {
            stockItemId: stockItemId,
            action: action
        };
        
        modal.show();
    }
    
    getTransactionTypeOptions(action) {
        const options = {
            'pick': '<option value="ship">Ship/Pick</option>',
            'receive': '<option value="receive">Receive</option>',
            'adjust': '<option value="adjust">Adjust</option>',
            'transfer': '<option value="reserve">Reserve</option><option value="release">Release</option>'
        };
        return options[action] || '<option value="adjust">Adjust</option>';
    }
    
    async submitTransaction() {
        const quantity = parseInt(document.getElementById('transactionQuantity').value);
        const transactionType = document.getElementById('transactionType').value;
        const notes = document.getElementById('transactionNotes').value;
        
        if (!quantity || quantity <= 0) {
            alert('Please enter a valid quantity');
            return;
        }
        
        const submitBtn = document.getElementById('submitTransaction');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/scanner/api/transaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    stock_item_id: this.currentTransaction.stockItemId,
                    type: transactionType,
                    quantity_change: quantity,
                    notes: notes
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                this.showSuccess(data);
                // Refresh bin data
                this.showBinDetails(this.currentBin.code);
            } else {
                alert('Error: ' + (data.error || 'Transaction failed'));
            }
        } catch (error) {
            console.error('Transaction error:', error);
            alert('Network error occurred');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
    
    showSuccess(data) {
        // Close transaction modal
        const transactionModal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
        transactionModal.hide();
        
        // Show success modal
        document.getElementById('successMessage').textContent = 
            `Successfully ${data.transaction.type}ed ${data.transaction.quantity_change} units of ${data.stock_item.product_name}`;
        
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        successModal.show();
    }
    
    showMoveStockModal(stockItemId, productName) {
        // Get the current stock item to populate the modal
        const stockItem = this.getStockItemById(stockItemId);
        if (!stockItem) {
            alert('Stock item not found');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('moveStockModal'));
        
        // Populate the "From" section with current stock item data
        document.getElementById('moveCurrentBinCode').value = this.currentBin.code;
        document.getElementById('moveCurrentLocation').value = this.currentBin.location_code || 'Not assigned';
        document.getElementById('moveCurrentWarehouse').value = this.currentBin.warehouse_name || 'Not assigned';
        document.getElementById('moveProductName').value = productName;
        document.getElementById('moveAvailableQuantity').value = stockItem.on_hand;
        
        // Reset the destination section
        document.getElementById('moveDestinationBinInput').value = '';
        document.getElementById('moveDestinationBinId').value = '';
        document.getElementById('moveDestinationLocation').value = '';
        document.getElementById('moveDestinationWarehouse').value = '';
        document.getElementById('moveQuantity').value = '1';
        document.getElementById('moveNotes').value = '';
        
        // Store current transaction data
        this.currentMoveTransaction = {
            stockItemId: stockItemId,
            productName: productName
        };
        
        modal.show();
    }
    
    getStockItemById(stockItemId) {
        // Find the stock item in the current bin's stock items
        if (!this.currentBin || !this.currentBin.stock_items) {
            return null;
        }
        
        return this.currentBin.stock_items.find(item => item.id === stockItemId);
    }
    
    setMoveAllStock() {
        // Get the available quantity from the readonly field
        const availableQuantity = document.getElementById('moveAvailableQuantity').value;
        if (availableQuantity && !isNaN(availableQuantity)) {
            document.getElementById('moveQuantity').value = availableQuantity;
        }
    }
    
    async searchLocations(query) {
        const autocomplete = document.getElementById('locationAutocomplete');
        
        if (!query || query.length < 1) {
            autocomplete.style.display = 'none';
            return;
        }
        
        try {
            const response = await fetch(`/warehouses/api/locations/search?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (data.success && data.locations.length > 0) {
                this.displayLocationResults(data.locations);
            } else {
                autocomplete.style.display = 'none';
            }
        } catch (error) {
            console.error('Error searching locations:', error);
            autocomplete.style.display = 'none';
        }
    }
    
    displayLocationResults(locations) {
        const autocomplete = document.getElementById('locationAutocomplete');
        
        autocomplete.innerHTML = locations.map(location => `
            <div class="autocomplete-item" data-location-code="${location.full_code}" data-location-id="${location.id}">
                <div class="fw-bold">${location.full_code}</div>
                <div class="text-muted small">${location.name || 'No name'}</div>
            </div>
        `).join('');
        
        // Add click handlers to autocomplete items
        autocomplete.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', () => {
                const locationCode = item.dataset.locationCode;
                document.getElementById('changeLocationInput').value = locationCode;
                document.getElementById('changeLocationNewLocation').value = locationCode;
                autocomplete.style.display = 'none';
            });
        });
        
        autocomplete.style.display = 'block';
    }
    
    cleanupModalBackdrop() {
        // Remove any backdrop elements that might be left behind
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Remove modal-open class from body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
    
    showChangeLocationModal() {
        if (!this.currentBin) {
            alert('No bin selected');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('changeLocationModal'));
        
        // Populate the modal with current bin information
        document.getElementById('changeLocationBinCode').value = this.currentBin.code;
        document.getElementById('changeLocationCurrentLocation').value = this.currentBin.location_code || 'Not assigned';
        
        // Reset the new location field
        document.getElementById('changeLocationInput').value = '';
        document.getElementById('changeLocationNewLocation').value = '';
        document.getElementById('changeLocationNotes').value = '';
        
        // Hide autocomplete dropdown
        document.getElementById('locationAutocomplete').style.display = 'none';
        
        modal.show();
    }
    
    async submitChangeLocation() {
        const newLocationCode = document.getElementById('changeLocationInput').value.trim();
        const notes = document.getElementById('changeLocationNotes').value;
        
        if (!newLocationCode) {
            alert('Please enter a new location code');
            return;
        }
        
        const submitBtn = document.getElementById('submitChangeLocation');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch(`/warehouses/api/bin/${this.currentBin.code}/change-location`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    new_location_code: newLocationCode,
                    notes: notes
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Close the change location modal properly
                const changeLocationModal = bootstrap.Modal.getInstance(document.getElementById('changeLocationModal'));
                if (changeLocationModal) {
                    changeLocationModal.hide();
                }
                
                // Clean up any lingering backdrop
                setTimeout(() => {
                    this.cleanupModalBackdrop();
                    
                    // Show success message
                    document.getElementById('successMessage').textContent = 
                        `Successfully changed bin location to ${newLocationCode}`;
                    
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    
                    // Refresh bin data
                    this.showBinDetails(this.currentBin.code);
                }, 300); // Small delay to ensure modal is fully closed
            } else {
                alert('Error: ' + (data.error || 'Failed to change location'));
            }
        } catch (error) {
            console.error('Change location error:', error);
            alert('Network error occurred');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
    
    // Include other methods like showAssignStockModal, showChangeLocationModal, etc.
    // (abbreviated for space - these would be similar to the scanner implementation)
    async showAssignStockModal() {
        if (!this.currentBin) {
            alert('No bin selected');
            return;
        }
        // Populate fields
        const binCodeInput = document.getElementById('assignBinCode');
        const locInput = document.getElementById('assignLocationCode');
        const productSelect = document.getElementById('assignProductId');
        document.getElementById('assignQuantity').value = '1';
        document.getElementById('assignBatchId').value = '';
        document.getElementById('assignExpiryDate').value = '';
        if (binCodeInput) binCodeInput.value = this.currentBin.code || '';
        if (locInput) locInput.value = this.currentBin.location_code || 'Not assigned';

        // Load products
        try {
            const res = await fetch('/scanner/api/products/available', { credentials: 'same-origin' });
            const data = await res.json();
            if (res.ok && data.success && Array.isArray(data.products)) {
                productSelect.innerHTML = '<option value="">Select a product...</option>' +
                    data.products.map(p => `<option value="${p.id}">${p.name}${p.sku ? ' (' + p.sku + ')' : ''}</option>`).join('');
            } else {
                productSelect.innerHTML = '<option value="">No products available</option>';
            }
        } catch (e) {
            productSelect.innerHTML = '<option value="">Error loading products</option>';
        }

        new bootstrap.Modal(document.getElementById('assignStockModal')).show();
    }

    async submitAssignStock() {
        if (!this.currentBin) return;
        const productId = document.getElementById('assignProductId').value;
        const qtyStr = document.getElementById('assignQuantity').value;
        const quantity = parseInt(qtyStr || '0', 10);
        const batchId = document.getElementById('assignBatchId').value || null;
        const expiryDate = document.getElementById('assignExpiryDate').value || null;

        if (!productId) { alert('Please select a product.'); return; }
        if (!quantity || quantity <= 0) { alert('Please enter a valid quantity.'); return; }

        const btn = document.getElementById('submitAssignStock');
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Assigning...';
        btn.disabled = true;

        try {
            // Use scanner transaction API with bin_assign type to avoid capacity dependency
            const res = await fetch('/scanner/api/transaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    type: 'bin_assign',
                    bin_code: this.currentBin.code,
                    product_id: productId,
                    quantity: quantity,
                    batch_id: batchId,
                    expiry_date: expiryDate
                })
            });
            const data = await res.json();
            if (res.ok && data.success) {
                // Close assign modal
                const assignModal = bootstrap.Modal.getInstance(document.getElementById('assignStockModal'));
                if (assignModal) assignModal.hide();
                this.cleanupModalBackdrop();
                // Show success and refresh
                document.getElementById('successMessage').textContent = 'Stock assigned to bin successfully';
                new bootstrap.Modal(document.getElementById('successModal')).show();
                // Refresh details to show new stock
                this.showBinDetails(this.currentBin.code);
            } else {
                alert(data.error || 'Failed to assign stock');
            }
        } catch (e) {
            alert('Network error while assigning stock');
        } finally {
            btn.innerHTML = original;
            btn.disabled = false;
        }
    }
}

// Initialize global bin details manager
window.binDetailsManager = new BinDetailsManager();
</script>
