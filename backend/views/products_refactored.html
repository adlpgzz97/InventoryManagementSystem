{% extends "base_refactored.html" %}

{% block title %}Products - Inventory Management{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Products</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            {% if current_user.role in ['admin', 'manager'] %}
            <button type="button" class="btn btn-sm btn-success add-btn" data-type="product" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus"></i> Add Product
            </button>
            {% endif %}
            <button type="button" class="btn btn-sm btn-outline-secondary" id="export-products">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Include components -->
{% from 'components/forms.html' import search_input, filter_select, action_button %}
{% from 'components/tables.html' import table_header, data_table, bulk_actions_toolbar, status_badge %}
{% from 'components/modals.html' import product_modal, confirmation_modal %}

<!-- Products Table -->
{% set table_columns = [
    {'key': 'sku', 'label': 'SKU', 'sortable': True, 'type': 'text'},
    {'key': 'name', 'label': 'Name', 'sortable': True, 'type': 'text'},
    {'key': 'category', 'label': 'Category', 'sortable': True, 'type': 'text'},
    {'key': 'price', 'label': 'Price', 'sortable': True, 'type': 'number'},
    {'key': 'stock_level', 'label': 'Stock Level', 'sortable': True, 'type': 'number'},
    {'key': 'status', 'label': 'Status', 'sortable': True, 'type': 'text'}
] %}

{% set table_filters = [
    {'type': 'search', 'id': 'search-products', 'placeholder': 'Search products (SKU, name, description)...', 'width': '5', 'scan_button': True},
    {'type': 'select', 'id': 'filter-category', 'options': {'widget': 'Widgets', 'gadget': 'Gadgets', 'tool': 'Tools', 'other': 'Other'}, 'placeholder': 'All Categories', 'width': '3'},
    {'type': 'select', 'id': 'filter-status', 'options': {'active': 'Active', 'inactive': 'Inactive'}, 'placeholder': 'All Statuses', 'width': '2'}
] %}

{% set table_actions = [
    {'id': 'add-product', 'text': 'Add Product', 'icon': 'plus', 'classes': 'success', 'data_type': 'product'}
] %}

{{ table_header("Product Inventory", "Manage your product catalog", table_actions, table_filters) }}

<!-- Bulk Actions Toolbar -->
{{ bulk_actions_toolbar('products', [
    {'id': 'export', 'text': 'Export Selected', 'icon': 'download', 'classes': 'primary'},
    {'id': 'delete', 'text': 'Delete Selected', 'icon': 'trash', 'classes': 'danger'}
]) }}

<!-- Products Data Table -->
{% block table_content %}
{{ data_table('products-table', table_columns, products, true, true, 'table-enhanced') }}

<!-- Row Actions Template -->
{% block row_actions scoped %}
<div class="btn-group btn-group-sm" role="group">
    <button type="button" class="btn btn-outline-primary btn-sm" 
            onclick="viewProduct('{{ row.id }}')" title="View Details">
        <i class="fas fa-eye"></i>
    </button>
    {% if current_user.role in ['admin', 'manager'] %}
    <button type="button" class="btn btn-outline-warning btn-sm" 
            onclick="editProduct('{{ row.id }}')" title="Edit Product">
        <i class="fas fa-edit"></i>
    </button>
    <button type="button" class="btn btn-outline-danger btn-sm" 
            onclick="deleteProduct('{{ row.id }}')" title="Delete Product">
        <i class="fas fa-trash"></i>
    </button>
    {% endif %}
</div>
{% endblock %}
{% endblock %}

<!-- Product Modals -->
{{ product_modal('addProductModal', 'Add New Product', 'Create Product') }}
{{ product_modal('editProductModal', 'Edit Product', 'Update Product') }}

<!-- Confirmation Modal -->
{{ confirmation_modal('deleteConfirmModal', 'Delete Product', 
   'Are you sure you want to delete this product? This action cannot be undone.', 
   'Delete', 'Cancel', 'btn-danger') }}

<!-- Product Details Modal -->
{% from 'components/modals.html' import details_modal %}
{{ details_modal('productDetailsModal', 'Product Details', 'xl') }}

{% block modal_content %}
<div id="product-details-content">
    <!-- Product details will be loaded here -->
</div>
{% endblock %}
{% endblock %}

{% block scripts %}
<script>
// Initialize table functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize table with components
    TableManager.initTable('products-table', {
        sortable: true,
        selectable: true,
        searchable: true,
        searchInputId: 'search-products'
    });
    
    // Initialize export functionality
    document.getElementById('export-products').addEventListener('click', function() {
        ExportManager.exportToCSV('products-table', 'products-export.csv');
    });
    
    // Initialize bulk export
    document.getElementById('bulk-export-products').addEventListener('click', function() {
        ExportManager.exportSelectedToCSV('products-table', 'selected-products-export.csv');
    });
    
    // Initialize bulk delete
    document.getElementById('bulk-delete-products').addEventListener('click', function() {
        const selectedRows = document.querySelectorAll('#products-table .row-selector:checked');
        if (selectedRows.length === 0) {
            Utils.showNotification('No products selected for deletion', 'warning');
            return;
        }
        
        const productIds = Array.from(selectedRows).map(row => row.value);
        deleteMultipleProducts(productIds);
    });
    
    // Initialize clear selection
    document.getElementById('clear-selection-products').addEventListener('click', function() {
        document.querySelectorAll('#products-table .row-selector').forEach(checkbox => {
            checkbox.checked = false;
        });
        TableManager.updateBulkActions(document.getElementById('products-table'));
    });
    
    // Initialize modal forms
    ModalManager.initForm('addProductModal', {
        onSubmit: function(data, form) {
            createProduct(data);
        }
    });
    
    ModalManager.initForm('editProductModal', {
        onSubmit: function(data, form) {
            updateProduct(data);
        }
    });
});

// Product management functions
function viewProduct(productId) {
    // Load product details via API
    APIManager.get(`/api/products/${productId}`)
        .then(product => {
            displayProductDetails(product);
            ModalManager.show('productDetailsModal');
        })
        .catch(error => {
            Utils.showNotification('Failed to load product details', 'danger');
        });
}

function editProduct(productId) {
    // Load product data for editing
    APIManager.get(`/api/products/${productId}`)
        .then(product => {
            populateEditForm(product);
            ModalManager.show('editProductModal');
        })
        .catch(error => {
            Utils.showNotification('Failed to load product for editing', 'danger');
        });
}

function deleteProduct(productId) {
    // Show confirmation modal
    document.getElementById('deleteConfirmModal-confirm').onclick = function() {
        APIManager.delete(`/api/products/${productId}`)
            .then(() => {
                Utils.showNotification('Product deleted successfully', 'success');
                location.reload();
            })
            .catch(error => {
                Utils.showNotification('Failed to delete product', 'danger');
            });
        ModalManager.hide('deleteConfirmModal');
    };
    
    ModalManager.show('deleteConfirmModal');
}

function deleteMultipleProducts(productIds) {
    // Show confirmation for bulk delete
    document.getElementById('deleteConfirmModal-confirm').onclick = function() {
        APIManager.post('/api/products/bulk-delete', { product_ids: productIds })
            .then(() => {
                Utils.showNotification(`${productIds.length} products deleted successfully`, 'success');
                location.reload();
            })
            .catch(error => {
                Utils.showNotification('Failed to delete products', 'danger');
            });
        ModalManager.hide('deleteConfirmModal');
    };
    
    document.querySelector('#deleteConfirmModal .modal-body p').textContent = 
        `Are you sure you want to delete ${productIds.length} products? This action cannot be undone.`;
    ModalManager.show('deleteConfirmModal');
}

function createProduct(data) {
    APIManager.post('/api/products', data)
        .then(() => {
            Utils.showNotification('Product created successfully', 'success');
            ModalManager.hide('addProductModal');
            ModalManager.resetForm('addProductModal');
            location.reload();
        })
        .catch(error => {
            Utils.showNotification('Failed to create product', 'danger');
        });
}

function updateProduct(data) {
    APIManager.put(`/api/products/${data.id}`, data)
        .then(() => {
            Utils.showNotification('Product updated successfully', 'success');
            ModalManager.hide('editProductModal');
            location.reload();
        })
        .catch(error => {
            Utils.showNotification('Failed to update product', 'danger');
        });
}

function populateEditForm(product) {
    const form = document.getElementById('editProductModal-form');
    Object.keys(product).forEach(key => {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) {
            input.value = product[key];
        }
    });
}

function displayProductDetails(product) {
    const content = document.getElementById('product-details-content');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>SKU:</strong></td><td>${product.sku}</td></tr>
                    <tr><td><strong>Name:</strong></td><td>${product.name}</td></tr>
                    <tr><td><strong>Category:</strong></td><td>${product.category || 'N/A'}</td></tr>
                    <tr><td><strong>Brand:</strong></td><td>${product.brand || 'N/A'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Financial Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Price:</strong></td><td>${Utils.formatCurrency(product.price)}</td></tr>
                    <tr><td><strong>Cost:</strong></td><td>${Utils.formatCurrency(product.cost)}</td></tr>
                    <tr><td><strong>Margin:</strong></td><td>${product.price && product.cost ? ((product.price - product.cost) / product.price * 100).toFixed(2) + '%' : 'N/A'}</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Description</h6>
                <p>${product.description || 'No description available'}</p>
            </div>
        </div>
    `;
}

// Filter functionality
document.getElementById('filter-category').addEventListener('change', function() {
    filterProducts();
});

document.getElementById('filter-status').addEventListener('change', function() {
    filterProducts();
});

function filterProducts() {
    const categoryFilter = document.getElementById('filter-category').value;
    const statusFilter = document.getElementById('filter-status').value;
    
    const rows = document.querySelectorAll('#products-table tbody tr');
    rows.forEach(row => {
        const category = row.querySelector('td[data-column="category"]')?.textContent || '';
        const status = row.querySelector('td[data-column="status"]')?.textContent || '';
        
        const categoryMatch = !categoryFilter || category.toLowerCase().includes(categoryFilter.toLowerCase());
        const statusMatch = !statusFilter || status.toLowerCase().includes(statusFilter.toLowerCase());
        
        row.style.display = categoryMatch && statusMatch ? '' : 'none';
    });
}
</script>
{% endblock %}
