{% if error_message %}
<div class="alert alert-danger">{{ error_message }}</div>
{% endif %}

<form method="post" id="addWarehouseForm" action="{{ url_for('warehouses.add_warehouse') }}?modal=1">
    <div class="mb-3">
        <label for="name" class="form-label">Warehouse Name <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="name" name="name" 
               placeholder="e.g., Main Warehouse" required>
    </div>
    
    <div class="mb-3">
        <label for="address" class="form-label">Address</label>
        <textarea class="form-control" id="address" name="address" rows="3" 
                  placeholder="Enter warehouse address..."></textarea>
        <small class="form-text text-muted">Full address including street, city, state, postal code</small>
    </div>
    
    <!-- Quick Setup Section -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-magic me-2"></i>Quick Setup</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="quick_areas" class="form-label">Number of Areas</label>
                    <input type="number" min="1" max="10" class="form-control" id="quick_areas" 
                           placeholder="e.g., 3" value="2">
                    <small class="form-text text-muted">Storage areas (A01, A02, etc.)</small>
                </div>
                <div class="col-md-4">
                    <label for="quick_racks" class="form-label">Racks per Area</label>
                    <input type="number" min="1" max="20" class="form-control" id="quick_racks" 
                           placeholder="e.g., 5" value="3">
                    <small class="form-text text-muted">Racks in each area (R01, R02, etc.)</small>
                </div>
                <div class="col-md-4">
                    <label for="quick_levels" class="form-label">Levels per Rack</label>
                    <input type="number" min="1" max="10" class="form-control" id="quick_levels" 
                           placeholder="e.g., 4" value="3">
                    <small class="form-text text-muted">Storage levels (L1, L2, etc.)</small>
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-outline-primary btn-sm" id="applyQuickSetup">
                    <i class="fas fa-play me-1"></i>Apply Quick Setup
                </button>
                <small class="text-muted ms-2">This will overwrite the current structure</small>
            </div>
        </div>
    </div>
    
    <!-- Hierarchical Storage Structure Section -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-sitemap me-2"></i>Storage Structure (Areas → Racks → Levels)</h6>
            <button type="button" class="btn btn-success btn-sm" id="addAreaBtn">
                <i class="fas fa-plus me-1"></i>Add Area
            </button>
        </div>
        <div class="card-body">
            <div id="areasList">
                <!-- Areas will be dynamically added here -->
            </div>
            <div id="noAreasMessage" class="text-center text-muted py-4">
                <i class="fas fa-sitemap fa-2x mb-2"></i>
                <p>No storage areas configured yet. Use Quick Setup or click "Add Area" to create the hierarchical structure.</p>
            </div>
        </div>
    </div>
    
    <!-- Hidden inputs for form submission -->
    <input type="hidden" id="hierarchicalData" name="hierarchical_data" value="">
    <input type="hidden" id="createLocations" name="create_locations" value="true">
    
    <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancel
        </button>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-plus me-2"></i>Add Warehouse
        </button>
    </div>
</form>

<p class="mt-2 text-muted"><span class="text-danger">*</span> Required field</p>

<style>
.area-row {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}

.area-row:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.rack-row {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 8px;
    margin-left: 15px;
}

.level-row {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    padding: 6px;
    margin-bottom: 5px;
    margin-left: 15px;
}

.area-header, .rack-header {
    font-weight: 600;
    color: #495057;
}

.area-header {
    color: #0d6efd;
}

.rack-header {
    color: #0dcaf0;
}

.level-item {
    color: #198754;
    font-size: 0.9rem;
}

.form-control-sm {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

.btn-sm {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

#noAreasMessage {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    background: #f8f9fa;
}

.badge {
    font-size: 0.7rem;
}

.area-actions, .rack-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}
</style>

<script>
    // Hierarchical Storage Structure Management
    let areasData = [];
    let areaCounter = 0;
    let rackCounter = 0;
    let levelCounter = 0;

    // Initialize with default structure
    document.addEventListener('DOMContentLoaded', function() {
        // Add a default area to get started
        addArea();
        updateHierarchicalData();
    });

    // Quick Setup functionality
    document.getElementById('applyQuickSetup').addEventListener('click', function() {
        const areas = parseInt(document.getElementById('quick_areas').value) || 2;
        const racksPerArea = parseInt(document.getElementById('quick_racks').value) || 3;
        const levelsPerRack = parseInt(document.getElementById('quick_levels').value) || 3;
        
        // Clear existing structure
        areasData = [];
        areaCounter = 0;
        rackCounter = 0;
        levelCounter = 0;
        
        // Create new structure
        for (let a = 1; a <= areas; a++) {
            const area = {
                id: `A${a.toString().padStart(2, '0')}`,
                name: `Area ${a.toString().padStart(2, '0')}`,
                code: `A${a.toString().padStart(2, '0')}`,
                racks: []
            };
            
            for (let r = 1; r <= racksPerArea; r++) {
                const rack = {
                    id: `R${r.toString().padStart(2, '0')}`,
                    name: `Rack ${r.toString().padStart(2, '0')}`,
                    code: `R${r.toString().padStart(2, '0')}`,
                    levels: []
                };
                
                for (let l = 1; l <= levelsPerRack; l++) {
                    rack.levels.push({
                        id: `L${l}`,
                        name: `Level ${l}`,
                        code: `L${l}`,
                        location_id: null,
                        full_code: '',
                        bin_count: 0
                    });
                }
                area.racks.push(rack);
            }
            areasData.push(area);
        }
        
        renderAreas();
        updateHierarchicalData();
    });

    function addArea() {
        const newArea = {
            id: `A${++areaCounter}`,
            name: `Area ${areaCounter.toString().padStart(2, '0')}`,
            code: `A${areaCounter.toString().padStart(2, '0')}`,
            racks: []
        };
        areasData.push(newArea);
        renderAreas();
        updateHierarchicalData();
    }

    function addRack(areaIndex) {
        const newRack = {
            id: `R${++rackCounter}`,
            name: `Rack ${rackCounter.toString().padStart(2, '0')}`,
            code: `R${rackCounter.toString().padStart(2, '0')}`,
            levels: []
        };
        areasData[areaIndex].racks.push(newRack);
        renderAreas();
        updateHierarchicalData();
    }

    function addLevel(areaIndex, rackIndex) {
        const newLevel = {
            id: `L${++levelCounter}`,
            name: `Level ${levelCounter}`,
            code: `L${levelCounter}`,
            location_id: null,
            full_code: '',
            bin_count: 0
        };
        areasData[areaIndex].racks[rackIndex].levels.push(newLevel);
        renderAreas();
        updateHierarchicalData();
    }

    function renderAreas() {
        const areasList = document.getElementById('areasList');
        const noAreasMessage = document.getElementById('noAreasMessage');
        
        if (areasData.length === 0) {
            areasList.innerHTML = '';
            noAreasMessage.style.display = 'block';
            return;
        }
        
        noAreasMessage.style.display = 'none';
        areasList.innerHTML = '';
        
        areasData.forEach((area, areaIndex) => {
            const areaElement = createAreaElement(area, areaIndex);
            areasList.appendChild(areaElement);
        });
    }

    function createAreaElement(area, areaIndex) {
        const areaDiv = document.createElement('div');
        areaDiv.className = 'area-row';
        areaDiv.innerHTML = `
            <div class="area-header d-flex align-items-center mb-2">
                <i class="bi bi-grid-3x3-gap me-2 text-primary"></i>
                <input type="text" class="form-control form-control-sm me-2" 
                       placeholder="Area Name" value="${area.name}" 
                       onchange="updateAreaName(${areaIndex}, this.value)" style="width: 150px;">
                <input type="text" class="form-control form-control-sm me-2" 
                       placeholder="Area Code" value="${area.code}" 
                       onchange="updateAreaCode(${areaIndex}, this.value)" style="width: 100px;">
                <button type="button" class="btn btn-info btn-sm me-2" onclick="addRack(${areaIndex})">
                    <i class="fas fa-plus"></i> Add Rack
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeArea(${areaIndex})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="racks-container">
                ${area.racks.map((rack, rackIndex) => createRackHTML(areaIndex, rack, rackIndex)).join('')}
            </div>
        `;
        return areaDiv;
    }

    function createRackHTML(areaIndex, rack, rackIndex) {
        return `
            <div class="rack-row">
                <div class="rack-header d-flex align-items-center mb-1">
                    <i class="bi bi-box me-2 text-info"></i>
                    <input type="text" class="form-control form-control-sm me-2" 
                           placeholder="Rack Name" value="${rack.name}" 
                           onchange="updateRackName(${areaIndex}, ${rackIndex}, this.value)" style="width: 120px;">
                    <input type="text" class="form-control form-control-sm me-2" 
                           placeholder="Rack Code" value="${rack.code}" 
                           onchange="updateRackCode(${areaIndex}, ${rackIndex}, this.value)" style="width: 80px;">
                    <button type="button" class="btn btn-success btn-sm me-2" onclick="addLevel(${areaIndex}, ${rackIndex})">
                        <i class="fas fa-plus"></i> Add Level
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRack(${areaIndex}, ${rackIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="levels-container">
                    ${rack.levels.map((level, levelIndex) => createLevelHTML(areaIndex, rackIndex, level, levelIndex)).join('')}
                </div>
            </div>
        `;
    }

    function createLevelHTML(areaIndex, rackIndex, level, levelIndex) {
        return `
            <div class="level-row">
                <div class="level-item d-flex align-items-center">
                    <i class="bi bi-layers me-2 text-success"></i>
                    <input type="text" class="form-control form-control-sm me-2" 
                           placeholder="Level Name" value="${level.name}" 
                           onchange="updateLevelName(${areaIndex}, ${rackIndex}, ${levelIndex}, this.value)" style="width: 100px;">
                    <input type="text" class="form-control form-control-sm me-2" 
                           placeholder="Level Code" value="${level.code}" 
                           onchange="updateLevelCode(${areaIndex}, ${rackIndex}, ${levelIndex}, this.value)" style="width: 60px;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeLevel(${areaIndex}, ${rackIndex}, ${levelIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }

    // Update functions
    function updateAreaName(areaIndex, name) {
        areasData[areaIndex].name = name;
        updateHierarchicalData();
    }

    function updateAreaCode(areaIndex, code) {
        areasData[areaIndex].code = code;
        updateHierarchicalData();
    }

    function updateRackName(areaIndex, rackIndex, name) {
        areasData[areaIndex].racks[rackIndex].name = name;
        updateHierarchicalData();
    }

    function updateRackCode(areaIndex, rackIndex, code) {
        areasData[areaIndex].racks[rackIndex].code = code;
        updateHierarchicalData();
    }

    function updateLevelName(areaIndex, rackIndex, levelIndex, name) {
        areasData[areaIndex].racks[rackIndex].levels[levelIndex].name = name;
        updateHierarchicalData();
    }

    function updateLevelCode(areaIndex, rackIndex, levelIndex, code) {
        areasData[areaIndex].racks[rackIndex].levels[levelIndex].code = code;
        updateHierarchicalData();
    }

    // Remove functions
    function removeArea(areaIndex) {
        areasData.splice(areaIndex, 1);
        renderAreas();
        updateHierarchicalData();
    }

    function removeRack(areaIndex, rackIndex) {
        areasData[areaIndex].racks.splice(rackIndex, 1);
        renderAreas();
        updateHierarchicalData();
    }

    function removeLevel(areaIndex, rackIndex, levelIndex) {
        areasData[areaIndex].racks[rackIndex].levels.splice(levelIndex, 1);
        renderAreas();
        updateHierarchicalData();
    }

    function updateHierarchicalData() {
        const hierarchicalData = {};
        
        areasData.forEach(area => {
            hierarchicalData[area.code] = {
                name: area.name,
                code: area.code,
                racks: {}
            };
            
            area.racks.forEach(rack => {
                hierarchicalData[area.code].racks[rack.code] = {
                    name: rack.name,
                    code: rack.code,
                    levels: {}
                };
                
                rack.levels.forEach(level => {
                    hierarchicalData[area.code].racks[rack.code].levels[level.code] = {
                        name: level.name,
                        code: level.code,
                        location_id: level.location_id,
                        full_code: level.full_code,
                        bin_count: level.bin_count
                    };
                });
            });
        });
        
        document.getElementById('hierarchicalData').value = JSON.stringify(hierarchicalData);
    }

    // Add Area button handler
    document.getElementById('addAreaBtn').addEventListener('click', addArea);

    // Form submission
    document.getElementById('addWarehouseForm').addEventListener('submit', function(e) {
        updateHierarchicalData();
    });
</script>
