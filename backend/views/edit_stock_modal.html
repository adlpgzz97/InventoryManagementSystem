{% if error_message %}
<div class="alert alert-danger">{{ error_message }}</div>
{% endif %}

<form method="post" id="editStockForm" action="{{ url_for('stock.edit_stock', stock_id=stock.id) }}?modal=1">
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="product_id" class="form-label">Product <span class="text-danger">*</span></label>
                <select class="form-select" id="product_id" name="product_id" required>
                    <option value="">Select Product</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" {% if product.id == stock.product_id %}selected{% endif %}>
                        {{ product.sku }} - {{ product.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="bin_id" class="form-label">Storage Bin <span class="text-danger">*</span></label>
                <select class="form-select" id="bin_id" name="bin_id" required>
                    <option value="">Select Storage Bin</option>
                    {% for bin in bins %}
                    <option value="{{ bin.id }}" {% if bin.id == stock.bin_id %}selected{% endif %}>
                        {{ bin.code }}
                    </option>
                    {% endfor %}
                </select>
                <div class="form-check mt-2" id="bin-toggle-container" style="display: none;">
                    <input class="form-check-input" type="checkbox" id="toggle-mode">
                    <label class="form-check-label" for="toggle-mode">Show bins with this product</label>
                </div>
                <small id="bin-help" class="form-text text-muted">Toggle on: only bins with this product. Toggle off: only empty bins. Bins occupied by other products are hidden.</small>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                                <label for="qty_available" class="form-label">Available Quantity <span class="text-danger">*</span></label>
                <input type="number" min="0" class="form-control" id="qty_available" name="qty_available"
                       value="{{ stock.on_hand }}" required>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="qty_reserved" class="form-label">Reserved Quantity <span class="text-danger">*</span></label>
                <input type="number" min="0" class="form-control" id="qty_reserved" name="qty_reserved" 
                       value="{{ stock.qty_reserved }}" required>
            </div>
        </div>
    </div>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Current Status:</strong>
                        {% if stock.on_hand == 0 %}
                    <span class="badge bg-danger">Out of Stock</span>
                {% elif stock.on_hand < 10 %}
                    <span class="badge bg-warning">Low Stock</span>
                {% else %}
                    <span class="badge bg-success">In Stock</span>
                {% endif %}
                | <strong>Total:</strong> {{ stock.on_hand + stock.qty_reserved }} units
    </div>
    
    <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-danger delete-btn" 
                data-type="stock" 
                data-id="{{ stock.id }}"
                data-name="stock item">
            <i class="fas fa-trash me-2"></i>Delete Stock Item
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Save Changes
        </button>
    </div>
</form>

<p class="mt-2 text-muted"><span class="text-danger">*</span> Required field</p>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('product_id');
    const binSelect = document.getElementById('bin_id');
    const toggleMode = document.getElementById('toggle-mode');

    function refreshBinsForSelection() {
        if (!binSelect) return;
        const selectedProduct = productSelect ? productSelect.value : '';
        const showSameOnly = toggleMode ? toggleMode.checked : false; // on = same-product; off = empty

        const previous = binSelect.value;
        const url = new URL('/stock/api/bin-availability', window.location.origin);
        if (selectedProduct) url.searchParams.set('product_id', selectedProduct);

        fetch(url.toString())
            .then(r => r.json())
            .then(data => {
                if (!data || !data.success) throw new Error(data && data.error ? data.error : 'Failed to load bins');
                const bins = Array.isArray(data.bins) ? data.bins : [];

                const filtered = bins.filter(b => {
                    // Require a location assignment
                    if (!b.location_id) return false;
                    // Always hide bins occupied by other products
                    if (b.occupied_by_other_product) return false;
                    
                    // If no product selected, only show empty bins
                    if (!selectedProduct) {
                        return !!b.is_empty;
                    }
                    
                    // If product selected, use toggle to determine what to show
                    if (showSameOnly) {
                        return !!b.occupied_by_same_product;
                    } else {
                        return !!b.is_empty;
                    }
                });

                const options = ['<option value="">Select Storage Bin</option>']
                    .concat(filtered.map(b => {
                        const codeText = (b.code && String(b.code).trim()) ? b.code : `Bin ${b.id}`;
                        const locText = (b.location_code && String(b.location_code).trim()) ? ` - ${b.location_code}` : '';
                        return `<option value="${b.id}">${escapeHtml(codeText + locText)}</option>`;
                    }));
                binSelect.innerHTML = options.join('');

                if (previous && filtered.some(b => b.id === previous)) {
                    binSelect.value = previous;
                } else {
                    binSelect.value = '';
                }
            })
            .catch(err => console.error('Failed to refresh bins:', err));
    }

    function escapeHtml(str) {
        return String(str || '').replace(/[&<>"]/g, function(c) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]); });
    }

    function updateToggleAvailability() {
        const toggleContainer = document.getElementById('bin-toggle-container');
        const hasProduct = !!(productSelect && productSelect.value);
        
        if (toggleContainer) {
            toggleContainer.style.display = hasProduct ? 'block' : 'none';
        }
        
        if (toggleMode) {
            toggleMode.disabled = !hasProduct;
            if (!hasProduct) toggleMode.checked = false;
        }
        
        const hint = document.getElementById('bin-help');
        if (hint) {
            hint.textContent = hasProduct
                ? 'Toggle on: only bins with this product. Toggle off: only empty bins. Bins occupied by other products are hidden.'
                : 'Select a product to enable showing bins with this product. Default shows only empty bins.';
        }
    }

    productSelect?.addEventListener('change', () => { updateToggleAvailability(); refreshBinsForSelection(); });
    toggleMode?.addEventListener('change', refreshBinsForSelection);
    updateToggleAvailability();
    // Clear initial server-rendered options and load filtered bins
    if (binSelect) {
        binSelect.innerHTML = '<option value="">Select Storage Bin</option>';
    }
    refreshBinsForSelection();
});
</script>