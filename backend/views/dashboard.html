{% extends "base.html" %}

{% block title %}Dashboard - Inventory Management{% endblock %}

{% block head %}
<!-- Chart.js for visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .metric-card {
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 1rem;
    }
    .alert-card {
        border-left: 4px solid;
    }
    .alert-danger {
        border-left-color: #dc3545;
    }
    .alert-warning {
        border-left-color: #ffc107;
    }
    .alert-info {
        border-left-color: #0dcaf0;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-bar me-2"></i>Dashboard & Analytics
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-data">
                <i class="fas fa-sync"></i> Refresh Data
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="export-report">
                <i class="fas fa-download"></i> Export Report
            </button>
        </div>
    </div>
</div>

<!-- Key Metrics Overview -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card h-100 border-primary">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="text-primary mb-1" id="total-products-metric">{{ stats.total_products }}</h3>
                        <p class="text-muted mb-0">Total Products</p>
                    </div>
                    <i class="fas fa-box fa-2x text-primary opacity-50"></i>
                </div>
                <small class="text-success">
                    <i class="fas fa-arrow-up"></i> Active inventory
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card h-100 border-success">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="text-success mb-1" id="total-stock-metric">{{ stats.total_stock_items }}</h3>
                        <p class="text-muted mb-0">Stock Items</p>
                    </div>
                    <i class="fas fa-boxes fa-2x text-success opacity-50"></i>
                </div>
                <small class="text-info">
                    <i class="fas fa-info-circle"></i> Individual records
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card h-100 border-warning">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="text-warning mb-1" id="low-stock-metric">{{ stats.low_stock_count }}</h3>
                        <p class="text-muted mb-0">Low Stock Items</p>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x text-warning opacity-50"></i>
                </div>
                <small class="text-danger">
                    <i class="fas fa-arrow-down"></i> Needs attention
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card h-100 border-info">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="text-info mb-1" id="total-value-metric">N/A</h3>
                        <p class="text-muted mb-0">Inventory Value</p>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x text-info opacity-50"></i>
                </div>
                <small class="text-muted">
                    <i class="fas fa-calculator"></i> Coming soon
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Alerts and Notifications -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i>Alerts & Notifications
                    <span class="badge bg-danger ms-2" id="total-alerts">{{ alerts|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if alerts %}
                <div class="row">
                    {% for alert in alerts %}
                    <div class="col-md-6 mb-3">
                        <div class="alert alert-{{ alert.type }} alert-card py-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ alert.title }}</strong>
                                    <br><small class="text-muted">{{ alert.message }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-{{ alert.type }}">{{ alert.count }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-check-circle text-success fa-2x"></i>
                    <p class="text-muted mt-2">No alerts at this time</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts and Analytics -->
<div class="row mb-4">
    <!-- Stock Level Distribution -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Stock Level Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="stockLevelChart"></canvas>
                </div>
                <div class="row text-center">
                    <div class="col-4">
                        <small class="text-success d-block">In Stock</small>
                        <strong id="in-stock-count">{{ stock_distribution.in_stock|default(0) }}</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-warning d-block">Low Stock</small>
                        <strong id="low-stock-count">{{ stock_distribution.low_stock|default(0) }}</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-danger d-block">Out of Stock</small>
                        <strong id="out-stock-count">{{ stock_distribution.out_of_stock|default(0) }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inventory by Warehouse -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-warehouse me-2"></i>Inventory by Warehouse
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="warehouseChart"></canvas>
                </div>
                <div class="mt-3">
                    {% for warehouse in warehouse_distribution %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ warehouse.name }}</span>
                        <div>
                            <span class="badge bg-primary">{{ warehouse.total_items }} items</span>
                            <span class="badge bg-secondary">{{ warehouse.total_qty }} units</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Batch Tracking Analytics -->
{% if batch_analytics %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tags me-2"></i>Batch Tracking Analytics
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <canvas id="batchExpiryChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <h6>Batch Summary</h6>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between">
                                <span>Total Batches</span>
                                <span class="badge bg-info">{{ batch_analytics.total_batches }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>Expiring Soon (30 days)</span>
                                <span class="badge bg-warning">{{ batch_analytics.expiring_soon }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>Already Expired</span>
                                <span class="badge bg-danger">{{ batch_analytics.expired }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>No Expiry Date</span>
                                <span class="badge bg-secondary">{{ batch_analytics.no_expiry }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Detailed Reports Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Detailed Stock Report
                        </h5>
                    </div>
                    <div class="col-auto">
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-filter me-1"></i>Filter View
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-filter="all">All Items</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="low-stock">Low Stock Only</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="out-of-stock">Out of Stock</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="batch-tracked">Batch Tracked</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="expiring">Expiring Soon</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="detailed-report-table">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Location</th>
                                <th>Available</th>
                                <th>Reserved</th>
                                <th>Batch Info</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in detailed_stock_report %}
                            <tr data-status="{{ item.status }}" data-batch-tracked="{{ item.is_batch_tracked }}" data-expiring="{{ item.is_expiring_soon }}">
                                <td>
                                    <strong>{{ item.product_name }}</strong>
                                    {% if item.is_batch_tracked %}
                                        <span class="badge bg-info ms-1">Batch Tracked</span>
                                    {% endif %}
                                </td>
                                <td><code>{{ item.sku }}</code></td>
                                <td>
                                    <small class="text-muted">{{ item.warehouse_name }}</small><br>
                                    {{ item.location }}
                                </td>
                                <td>
                                    <span class="fw-bold">{{ item.on_hand }}</span>
                                </td>
                                <td>{{ item.qty_reserved }}</td>
                                <td>
                                    {% if item.batch_id %}
                                        <div class="small">
                                            <strong>{{ item.batch_id }}</strong>
                                            {% if item.expiry_date %}
                                                <br><span class="text-muted">Exp: {{ item.expiry_date }}</span>
                                                {% if item.is_expiring_soon %}
                                                    <span class="badge bg-warning">Expiring Soon</span>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.status == 'out_of_stock' %}
                                        <span class="badge bg-danger">Out of Stock</span>
                                    {% elif item.status == 'low_stock' %}
                                        <span class="badge bg-warning">Low Stock</span>
                                    {% else %}
                                        <span class="badge bg-success">In Stock</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="quickEdit('{{ item.stock_id }}')" 
                                                title="Quick Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" 
                                                onclick="viewHistory('{{ item.stock_id }}')" 
                                                title="View History">
                                            <i class="fas fa-history"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initializeCharts();
    
    // Set up event listeners
    setupEventListeners();
    
    // Auto-refresh data every 5 minutes
    setInterval(refreshData, 300000);
});

function initializeCharts() {
    // Stock Level Distribution Chart
    const stockLevelCtx = document.getElementById('stockLevelChart').getContext('2d');
    new Chart(stockLevelCtx, {
        type: 'doughnut',
        data: {
            labels: ['In Stock', 'Low Stock', 'Out of Stock'],
            datasets: [{
                data: [{{ stock_distribution.in_stock|default(0) }}, {{ stock_distribution.low_stock|default(0) }}, {{ stock_distribution.out_of_stock|default(0) }}],
                backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Warehouse Distribution Chart
    const warehouseCtx = document.getElementById('warehouseChart').getContext('2d');
    new Chart(warehouseCtx, {
        type: 'bar',
        data: {
            labels: [{% for warehouse in warehouse_distribution %}'{{ warehouse.name }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Total Items',
                data: [{% for warehouse in warehouse_distribution %}{{ warehouse.total_items }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: '#0d6efd',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    
    {% if batch_analytics %}
    // Batch Expiry Timeline Chart
    const batchCtx = document.getElementById('batchExpiryChart').getContext('2d');
    new Chart(batchCtx, {
        type: 'line',
        data: {
            labels: [{% for point in batch_analytics.expiry_timeline %}'{{ point.month }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Batches Expiring',
                data: [{% for point in batch_analytics.expiry_timeline %}{{ point.count }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    {% endif %}
}

function setupEventListeners() {
    // Refresh data button
    document.getElementById('refresh-data').addEventListener('click', refreshData);
    
    // Export report button
    document.getElementById('export-report').addEventListener('click', exportReport);
    
    // Filter dropdown
    document.querySelectorAll('[data-filter]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            filterTable(this.dataset.filter);
        });
    });
}

function refreshData() {
    // Show loading state
    const btn = document.getElementById('refresh-data');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    btn.disabled = true;
    
    // Reload the page to get fresh data
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function exportReport() {
    // Generate CSV report
    const table = document.getElementById('detailed-report-table');
    const rows = table.querySelectorAll('tr');
    let csvContent = '';
    
    // Headers
    const headers = Array.from(rows[0].cells).map(cell => cell.textContent.trim()).slice(0, -1); // Exclude actions
    csvContent += headers.join(',') + '\n';
    
    // Data rows
    for (let i = 1; i < rows.length; i++) {
        if (rows[i].style.display !== 'none') {
            const cells = Array.from(rows[i].cells).slice(0, -1); // Exclude actions
            const rowData = cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`);
            csvContent += rowData.join(',') + '\n';
        }
    }
    
    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `inventory_report_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function filterTable(filter) {
    const table = document.getElementById('detailed-report-table');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        let show = true;
        
        switch(filter) {
            case 'low-stock':
                show = row.dataset.status === 'low_stock';
                break;
            case 'out-of-stock':
                show = row.dataset.status === 'out_of_stock';
                break;
            case 'batch-tracked':
                show = row.dataset.batchTracked === 'true';
                break;
            case 'expiring':
                show = row.dataset.expiring === 'true';
                break;
            case 'all':
            default:
                show = true;
                break;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function quickEdit(stockId) {
    // Open edit modal for quick stock adjustments
    if (window.loadEditModal) {
        window.loadEditModal('stock', stockId);
    } else {
        alert('Quick edit functionality requires the main application modal system.');
    }
}

function viewHistory(stockId) {
    // TODO: Implement stock movement history view
    alert(`Stock history for item ${stockId} - Coming in next phase!`);
}
</script>
{% endblock %}

